<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>我们的每一天</title>
  <style>
:root {
  --c-bg-main: #f6f7fb;
  --c-bg-panel: rgba(255,255,255,0.9);
  --c-bg-soft: #eef0f6;

  --c-text-main: #2b2e3a;
  --c-text-sub: #7a7f99;
  --c-text-muted: #b3b7cc;

  --radius-sm: 8px;
  --radius-md: 14px;
  --radius-lg: 20px;

  --shadow-soft: 0 10px 26px rgba(0,0,0,0.08);
  --transition: all .25s ease;
}

/* ===== 页面背景 ===== */
body {
  margin: 0;
  padding: 32px 16px;
  min-height: 100vh;
  background:
    radial-gradient(1200px 800px at 20% 0%, #e8eaff 0%, transparent 60%),
    radial-gradient(1000px 700px at 80% 10%, #f6e9f3 0%, transparent 55%),
    var(--c-bg-main);
  font-family: -apple-system, BlinkMacSystemFont, "Inter",
               "PingFang SC", "Noto Sans SC", sans-serif;
  color: var(--c-text-main);
}

/* ===== 日历外框 ===== */
.calendar-panel {
  background: var(--c-bg-panel);
  border-radius: var(--radius-lg);
  padding: 24px;
  box-shadow: var(--shadow-soft);
}

/* ===== 标题 ===== */
.calendar-title {
  text-align: center;
  font-size: 1.6rem;
  margin-bottom: 20px;
}

/* ===== 关键：把 table 变成 Grid ===== */
.calendar-table {
  display: grid;
  grid-template-columns: repeat(7, 1fr);
  gap: 12px;
}

/* table 语义保留，但不参与布局 */
.calendar-table tr,
.calendar-table td {
  display: contents;
}

/* ===== 日期格子（统一大小的核心） ===== */
.date-cell {
  aspect-ratio: 1 / 1;
  width: 100%;
  background: var(--c-bg-soft);
  border-radius: var(--radius-md);
  position: relative;
  padding: 8px;
  box-sizing: border-box;
  transition: var(--transition);
}

.date-cell:hover {
  transform: translateY(-2px);
  box-shadow: var(--shadow-soft);
}

/* 日期数字 */
.date-number {
  position: absolute;
  top: 6px;
  right: 8px;
  font-size: 0.75rem;
  color: var(--c-text-muted);
}

/* 内容居中 */
.date-content {
  height: 100%;
  display: flex;
  flex-direction: column;
  align-items: center;
  justify-content: center;
}

.date-tag {
  font-size: 0.85rem;
  font-weight: 500;
}

.date-subtitle {
  font-size: 0.7rem;
  color: var(--c-text-sub);
  margin-top: 4px;
  text-align: center;
}

/* ===== 特殊状态（鲜艳版本） ===== */
.date-cell.anniversary {
  background: linear-gradient(135deg, #ffe3f1, #ffd1e8);
  border: 2px solid #ff6fb1;
}

.date-cell.menstruation {
  background: linear-gradient(135deg, #ffe1e1, #ffcaca);
  border: 2px solid #ff5a5a;
}

.date-cell.birthday {
  background: linear-gradient(135deg, #e1f0ff, #cfe6ff);
  border: 2px solid #4da3ff;
}

.date-cell.record {
  background: linear-gradient(135deg, #fff3d6, #ffe6ad);
  border: 2px solid #ffb703;
}

/* ===== 手机适配 ===== */
@media (max-width: 640px) {

  body {
    padding: 20px 10px;
  }

  .calendar-panel {
    padding: 16px;
  }

  .calendar-table {
    gap: 6px;
  }

  .date-cell {
    padding: 5px;
  }

  .date-number {
    font-size: 0.6rem;
  }

  .date-tag {
    font-size: 0.7rem;
  }

  .date-subtitle {
    font-size: 0.6rem;
  }

  .calendar-title {
    font-size: 1.2rem;
  }
}
</style>

</head>
<body>
    <!-- 顶部统计区域 -->
    <div class="stats-container">
        <h1 class="stats-title">我们的时光印记</h1>
        <div class="days-stats">
            <div class="day-item">已相遇 <span class="day-number" id="meet-days">0</span> 天</div>
            <div class="day-item">已相恋 <span class="day-number" id="love-days">0</span> 天</div>
        </div>
        <!-- 只保留生日倒计时 -->
        <div class="birthday-tips">
            <div id="next-chiyo-birthday">距离 千代的生日 还有 0 天</div>
            <div id="next-xiaode-birthday">距离 小德的生日 还有 0 天</div>
        </div>
    </div>

    <!-- 标记类型选择 -->
    <div class="tag-selector">
        <div class="tag-item tag-anniversary" data-tag="anniversary">纪念日</div>
        <div class="tag-item tag-menstruation" data-tag="menstruation">生理期</div>
        <div class="tag-item tag-birthday" data-tag="birthday">生日</div>
        <div class="tag-item tag-record" data-tag="record">记录</div>
    </div>

    <!-- 功能按钮 -->
    <div class="btn-container">
        <button class="btn btn-add-calendar" onclick="addNextCalendar()">新增下一个月日历</button>
        <button class="btn btn-save" onclick="saveToCloud()">保存日历到云端</button>
        <button class="btn btn-load" onclick="loadFromCloud()">从云端读取日历</button>
    </div>

    <!-- 日历容器（新日历在上，旧日历在下） -->
    <div class="calendar-container" id="calendar-wrapper"></div>

    <!-- Firebase 配置与核心逻辑 -->
    <script type="module">
        // 导入 Firebase
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import {
            getFirestore,
            collection,
            writeBatch,
            getDocs,
            doc
        } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

        // Firebase 配置（沿用原有项目配置）
        const firebaseConfig = {
            apiKey: "AIzaSyAhZtgaE8mL3GkxsIj17g1ha-Y5HG02C_A",
            authDomain: "weight-zqy.firebaseapp.com",
            projectId: "weight-zqy",
            storageBucket: "weight-zqy.firebasestorage.app",
            messagingSenderId: "710580530798",
            appId: "1:710580530798:web:30e48f089452364c02c07f"
        };

        // 初始化 Firebase
        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);
        const CALENDAR_KEY = "our_days_calendars_v1"; // 本地存储键

        // 核心常量配置
        const MEET_DATE = new Date(2025, 5, 7); // 相遇日期：2025年6月7日（月份从0开始）
        const LOVE_DATE = new Date(2025, 8, 21); // 相恋日期：2025年9月21日
        // 二人固定生日
        const BIRTHDAYS = {
            chiyo: { month: 9, day: 21, name: "千代" }, // 10月21日（月份从0开始）
            xiaode: { month: 8, day: 26, name: "小德" }  // 9月26日
        };
        let activeTag = null; // 当前选中的标记类型
        let calendarData = {
            calendars: [], // 存储日历列表（{ year: 2025, month: 5, dates: [] }）
            tags: {} // 存储日期标记（key: "2025-06-07", value: { type: "anniversary", subtitle: "" }）
        };

        // ========== 初始化与本地数据加载 ==========
        function init() {
            // 加载本地数据
            const localData = localStorage.getItem(CALENDAR_KEY);
            if (localData) {
                calendarData = JSON.parse(localData);
            } else {
                // 初始化默认日历：2025年6月
                addCalendar(2025, 5, true);
            }

            // 绑定标记选择事件
            bindTagSelector();

            // 更新统计数据
            updateStats();

            // 渲染所有日历
            renderAllCalendars();

            // 定时更新统计（每分钟）
            setInterval(updateStats, 60000);
        }

        // ========== 日历操作 ==========
        // 添加指定年月的日历（isInit：是否为初始化，不自动排序列表）
        function addCalendar(year, month, isInit = false) {
            // 检查是否已存在该年月的日历
            const exists = calendarData.calendars.some(c => c.year === year && c.month === month);
            if (exists) return;

            // 生成当月日期数据
            const dateCount = new Date(year, month + 1, 0).getDate(); // 当月天数
            const dates = Array.from({ length: dateCount }, (_, i) => i + 1);

            // 添加日历数据
            const newCalendar = { year, month, dates };
            calendarData.calendars.push(newCalendar);

            // 非初始化状态下，按「新日期在上」排序（年月倒序）
            if (!isInit) {
                calendarData.calendars.sort((a, b) => {
                    if (a.year !== b.year) return b.year - a.year;
                    return b.month - a.month;
                });
            }

            // 保存本地并渲染
            saveToLocal();
            if (!isInit) renderAllCalendars();

            // 自动生成周年标记（修复：仅对应月份生成）
            generateAnniversaryTags(year, month);
        }

        // 新增下一个月日历
        function addNextCalendar() {
            if (calendarData.calendars.length === 0) {
                addCalendar(2025, 5);
                return;
            }

            // 获取最新的日历（列表第一个，因为已排序）
            const latest = calendarData.calendars[0];
            let nextYear = latest.year;
            let nextMonth = latest.month + 1;

            // 跨年份处理
            if (nextMonth > 11) {
                nextYear += 1;
                nextMonth = 0;
            }

            // 添加下一个月日历
            addCalendar(nextYear, nextMonth);
        }

        // 删除指定年月的日历（带二次确认）
        function deleteCalendar(year, month) {
            // 二次确认弹窗，防止误触
            const isConfirm = confirm(`确定要删除 ${year}年${month + 1}月 的日历吗？删除后该月所有标记也会一并清除，且无法恢复！`);
            if (!isConfirm) return;

            // 1. 从日历列表中删除该月
            calendarData.calendars = calendarData.calendars.filter(c => !(c.year === year && c.month === month));

            // 2. 清除该月所有日期标记（格式：yyyy-mm-dd）
            const monthStr = String(month + 1).padStart(2, "0");
            const datePrefix = `${year}-${monthStr}-`;
            Object.keys(calendarData.tags).forEach(dateStr => {
                if (dateStr.startsWith(datePrefix)) {
                    delete calendarData.tags[dateStr];
                }
            });

            // 3. 保存本地并重新渲染
            saveToLocal();
            renderAllCalendars();
            updateStats();
            alert(`${year}年${month + 1}月 日历已成功删除！`);
        }

        // 渲染所有日历
        function renderAllCalendars() {
            const wrapper = document.getElementById("calendar-wrapper");
            wrapper.innerHTML = "";

            // 遍历日历列表，逐个渲染
            calendarData.calendars.forEach(calendar => {
                const calendarPanel = createCalendarPanel(calendar);
                wrapper.appendChild(calendarPanel);
            });
        }

        // 创建单个日历面板（新增月删除按钮）
        function createCalendarPanel(calendar) {
            const { year, month, dates } = calendar;
            const monthName = new Date(year, month).toLocaleDateString("zh-CN", { year: "numeric", month: "long" });

            // 创建日历面板容器
            const panel = document.createElement("div");
            panel.className = "calendar-panel";
            panel.dataset.year = year;
            panel.dataset.month = month;

            // 1. 添加月删除按钮（左上角×）
            const calendarCloseBtn = document.createElement("div");
            calendarCloseBtn.className = "calendar-close";
            calendarCloseBtn.innerText = "×";
            calendarCloseBtn.addEventListener("click", () => {
                deleteCalendar(year, month);
            });
            panel.appendChild(calendarCloseBtn);

            // 2. 日历标题
            const title = document.createElement("h2");
            title.className = "calendar-title";
            title.innerText = monthName;
            panel.appendChild(title);

            // 3. 日历表格
            const table = document.createElement("table");
            table.className = "calendar-table";

            // 表格头部（星期）
            const thead = document.createElement("thead");
            const weekTr = document.createElement("tr");
            const weeks = ["日", "一", "二", "三", "四", "五", "六"];
            weeks.forEach(week => {
                const th = document.createElement("th");
                th.className = "calendar-th";
                th.innerText = week;
                weekTr.appendChild(th);
            });
            thead.appendChild(weekTr);
            table.appendChild(thead);

            // 表格内容（日期）
            const tbody = document.createElement("tbody");
            const firstDay = new Date(year, month, 1).getDay(); // 当月1号是星期几（0=周日）
            let dateIndex = 0;
            let row = document.createElement("tr");

            // 填充月初空白单元格
            for (let i = 0; i < firstDay; i++) {
                const td = document.createElement("td");
                row.appendChild(td);
            }

            // 填充日期单元格
            dates.forEach(date => {
                // 新建行（每7个单元格一行）
                if (row.children.length >= 7) {
                    tbody.appendChild(row);
                    row = document.createElement("tr");
                }

                const td = document.createElement("td");
                td.className = "calendar-td";

                const dateStr = `${year}-${String(month + 1).padStart(2, "0")}-${String(date).padStart(2, "0")}`;
                const tagInfo = calendarData.tags[dateStr] || {};

                // 创建日期单元格内容
                const dateCell = document.createElement("div");
                dateCell.className = `date-cell ${tagInfo.type || ""}`;
                dateCell.dataset.date = dateStr;

                // 日期数字（右上角）
                const dateNumber = document.createElement("div");
                dateNumber.className = "date-number";
                dateNumber.innerText = date;
                dateCell.appendChild(dateNumber);

                // 取消按钮（仅标记单元格显示）
                if (tagInfo.type) {
                    const closeBtn = document.createElement("div");
                    closeBtn.className = "date-close";
                    closeBtn.innerText = "×";
                    closeBtn.addEventListener("click", (e) => {
                        e.stopPropagation(); // 阻止触发单元格点击事件
                        delete calendarData.tags[dateStr];
                        saveToLocal();
                        renderAllCalendars();
                        updateStats();
                    });
                    dateCell.appendChild(closeBtn);
                }

                // 标记内容容器（居中）
                const contentContainer = document.createElement("div");
                contentContainer.className = "date-content";
                dateCell.appendChild(contentContainer);

                // 标记标题 + 副标题（居中显示）
                if (tagInfo.type) {
                    const tagMap = {
                        anniversary: "纪念日",
                        menstruation: "生理期",
                        birthday: "生日",
                        record: "记录"
                    };
                    const tagTitle = document.createElement("div");
                    tagTitle.className = "date-tag";
                    tagTitle.innerText = tagInfo.anniversaryYear ? `${tagInfo.anniversaryYear}周年${tagMap[tagInfo.type]}` : tagMap[tagInfo.type];
                    contentContainer.appendChild(tagTitle);

                    // 副标题
                    const subtitle = document.createElement("div");
                    subtitle.className = "date-subtitle";
                    subtitle.innerText = tagInfo.subtitle || "";
                    contentContainer.appendChild(subtitle);
                }

                // 绑定单元格点击事件（标记/编辑副标题）
                dateCell.addEventListener("click", handleDateCellClick);
                td.appendChild(dateCell);
                row.appendChild(td);
            });

            // 填充月末空白单元格
            while (row.children.length < 7) {
                const emptyTd = document.createElement("td");
                row.appendChild(emptyTd);
            }
            tbody.appendChild(row);
            table.appendChild(tbody);
            panel.appendChild(table);

            return panel;
        }

        // ========== 标记与编辑功能 ==========
        // 绑定标记选择事件
        function bindTagSelector() {
            const tagItems = document.querySelectorAll(".tag-item");
            tagItems.forEach(item => {
                item.addEventListener("click", () => {
                    tagItems.forEach(t => t.classList.remove("active"));
                    item.classList.add("active");
                    activeTag = item.dataset.tag;
                });
            });
        }

        // 处理日期单元格点击
        function handleDateCellClick() {
            const dateStr = this.dataset.date;
            const tagInfo = calendarData.tags[dateStr] || {};

            // 有活跃标记：添加/更新标记
            if (activeTag) {
                calendarData.tags[dateStr] = {
                    type: activeTag,
                    subtitle: tagInfo.subtitle || "",
                    anniversaryYear: tagInfo.anniversaryYear || null
                };
                saveToLocal();
                renderAllCalendars();
                updateStats();
                return;
            }

            // 无活跃标记：编辑副标题（已有标记的单元格）
            if (tagInfo.type) {
                const cell = this;
                const contentContainer = cell.querySelector(".date-content");
                const currentSubtitle = tagInfo.subtitle || "";

                // 创建输入框
                const input = document.createElement("input");
                input.className = "subtitle-input";
                input.value = currentSubtitle;
                input.setAttribute("maxlength", "50");

                // 清空内容容器，添加输入框
                contentContainer.innerHTML = "";
                contentContainer.appendChild(input);
                input.focus();

                // 输入框失去焦点时保存
                input.addEventListener("blur", () => {
                    calendarData.tags[dateStr].subtitle = input.value.trim();
                    saveToLocal();
                    renderAllCalendars();
                });

                // 回车保存
                input.addEventListener("keydown", (e) => {
                    if (e.key === "Enter") input.blur();
                });
            }
        }

        // 生成周年标记（修复核心：仅在「相同月份」生成周年，解决每月都出现的BUG）
        function generateAnniversaryTags(targetYear, targetMonth) {
            const targetDateStrPrefix = `${targetYear}-${String(targetMonth + 1).padStart(2, "0")}`;

            // 遍历所有标记，找出纪念日和生日
            Object.entries(calendarData.tags).forEach(([dateStr, tagInfo]) => {
                if (!["anniversary", "birthday"].includes(tagInfo.type)) return;

                // 解析原始标记日期
                const [origYear, origMonth, origDay] = dateStr.split("-").map(Number);
                // 修复点1：仅当「目标月份 === 原始标记月份」时，才生成周年（核心逻辑）
                if (targetMonth + 1 !== origMonth) return; // 注意：origMonth是字符串转数字（1-12），targetMonth是索引（0-11）

                const targetDateStr = `${targetDateStrPrefix}-${String(origDay).padStart(2, "0")}`;

                // 计算周年数（仅当目标年月 >= 原始年月时生成）
                const targetDate = new Date(targetYear, targetMonth, origDay);
                const origDate = new Date(origYear, origMonth - 1, origDay); // origMonth转索引（0-11）
                if (targetDate < origDate) return;

                const anniversaryYear = targetYear - origYear;
                if (anniversaryYear <= 0) return;

                // 检查目标日期是否存在（当月有该日期）
                const targetMonthDays = new Date(targetYear, targetMonth + 1, 0).getDate();
                if (origDay > targetMonthDays) return;

                // 修复点2：避免重复生成（已存在该标记则跳过）
                if (calendarData.tags[targetDateStr]) return;

                // 添加周年标记
                calendarData.tags[targetDateStr] = {
                    type: tagInfo.type,
                    subtitle: tagInfo.subtitle || "",
                    anniversaryYear: anniversaryYear
                };
            });

            saveToLocal();
        }

        // ========== 统计数据更新 ==========
        function updateStats() {
            const now = new Date();

            // 计算已相遇/相恋天数
            const meetDays = Math.floor((now - MEET_DATE) / (1000 * 60 * 60 * 24));
            const loveDays = Math.floor((now - LOVE_DATE) / (1000 * 60 * 60 * 24));

            // 更新页面显示
            document.getElementById("meet-days").innerText = Math.max(0, meetDays);
            document.getElementById("love-days").innerText = Math.max(0, loveDays);

            // 更新二人的生日倒计时
            updateBirthdayTips(now);
        }

        // 更新二人的生日倒计时
        function updateBirthdayTips(now) {
            // 千代的生日
            const chiyoBirthday = new Date(now.getFullYear(), BIRTHDAYS.chiyo.month, BIRTHDAYS.chiyo.day);
            if (chiyoBirthday < now) chiyoBirthday.setFullYear(now.getFullYear() + 1);
            const chiyoDays = Math.floor((chiyoBirthday - now) / (1000 * 60 * 60 * 24)) + 1;
            document.getElementById("next-chiyo-birthday").innerText = `距离 ${BIRTHDAYS.chiyo.name}的生日 还有 ${chiyoDays} 天`;

            // 小德的生日
            const xiaodeBirthday = new Date(now.getFullYear(), BIRTHDAYS.xiaode.month, BIRTHDAYS.xiaode.day);
            if (xiaodeBirthday < now) xiaodeBirthday.setFullYear(now.getFullYear() + 1);
            const xiaodeDays = Math.floor((xiaodeBirthday - now) / (1000 * 60 * 60 * 24)) + 1;
            document.getElementById("next-xiaode-birthday").innerText = `距离 ${BIRTHDAYS.xiaode.name}的生日 还有 ${xiaodeDays} 天`;
        }

        // ========== 数据存储 ==========
        // 保存到本地 localStorage
        function saveToLocal() {
            localStorage.setItem(CALENDAR_KEY, JSON.stringify(calendarData));
        }

        // 保存到 Firebase 云端
        async function saveToCloudImpl() {
            try {
                const calendarsRef = collection(db, "our_days_calendars");

                // 步骤1：删除云端旧数据
                const oldSnap = await getDocs(calendarsRef);
                const batch = writeBatch(db);
                oldSnap.docs.forEach(docItem => {
                    batch.delete(docItem.ref);
                });
                await batch.commit();

                // 步骤2：批量上传最新日历数据
                const newBatch = writeBatch(db);
                const docRef = doc(calendarsRef);
                newBatch.set(docRef, {
                    ...calendarData,
                    updateTime: Date.now()
                });
                await newBatch.commit();

                alert("日历数据已成功保存到云端！");
            } catch (e) {
                alert(`保存失败：${e.message || JSON.stringify(e)}`);
                console.error("云端保存错误：", e);
            }
        }

        // 从 Firebase 云端读取
        async function loadFromCloudImpl() {
            try {
                const calendarsRef = collection(db, "our_days_calendars");
                const snap = await getDocs(calendarsRef);

                if (snap.empty) {
                    alert("云端暂无日历数据！");
                    return;
                }

                // 提取最新数据
                const cloudData = snap.docs[0].data();
                calendarData.calendars = cloudData.calendars || [];
                calendarData.tags = cloudData.tags || {};

                // 保存到本地并渲染
                saveToLocal();
                renderAllCalendars();
                updateStats();
                alert("日历数据已从云端成功读取！");
            } catch (e) {
                alert(`读取失败：${e.message || JSON.stringify(e)}`);
                console.error("云端读取错误：", e);
            }
        }

        // ========== 全局函数挂载 ==========
        window.addNextCalendar = addNextCalendar;
        window.saveToCloud = saveToCloudImpl;
        window.loadFromCloud = loadFromCloudImpl;

        // ========== 页面初始化 ==========
        init();
    </script>
</body>
</html>
