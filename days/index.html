<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>我们的每一天</title>
  <style>
:root {
    /* 法式高级配色方案 - 柔和莫兰迪+精致金棕调（女生喜爱的法式优雅感） */
    --color-anniversary: #F8E9F0; /* 法式粉（纪念日） */
    --color-anniversary-border: #D8A7B1;
    --color-menstruation: #F9E6E8; /* 法式红（生理期） */
    --color-menstruation-border: #C98A8A;
    --color-birthday: #E6F0F8; /* 法式蓝（生日） */
    --color-birthday-border: #9AB3C9;
    --color-record: #F8F5E6; /* 法式黄（记录） */
    --color-record-border: #D9CC9A;
    --color-bg-primary: #FFFFFF;
    --color-bg-secondary: #F9F7F5; /* 法式米白背景，柔和不刺眼 */
    --color-bg-tertiary: #F5F2EF;
    --color-text-primary: #2C2825; /* 法式深棕文字，比纯黑更高级 */
    --color-text-secondary: #7A726B;
    --color-text-tertiary: #B0A8A0;
    --color-accent: #A67C52; /* 法式焦糖金棕，作为强调色 */
    --color-accent-light: #E8D9C7;
    --color-close: #9A928B;
    --color-close-hover: #C98A8A;
    --shadow-sm: 0 2px 8px rgba(0, 0, 0, 0.03); /* 柔和阴影，法式低饱和阴影 */
    --shadow-md: 0 4px 16px rgba(0, 0, 0, 0.06);
    --radius-sm: 4px; /* 小圆角，法式精致感（拒绝大圆角的可爱风） */
    --radius-md: 8px;
    --radius-lg: 12px;
    --transition-default: all 0.3s ease-in-out;
    --calendar-fixed-width: 1200px; /* 日历固定宽度，不顶屏幕两端 */
    --date-cell-size: 80px; /* 日期格子固定尺寸：80px×80px */
}

* {
    margin: 0;
    padding: 0;
    box-sizing: border-box;
    font-family: "Garamond", "Times New Roman", "Noto Serif SC", serif; /* 衬线字体，打造法式艺术氛围 */
}

body {
    background-color: var(--color-bg-secondary);
    color: var(--color-text-primary);
    padding: 32px 16px;
    max-width: var(--calendar-fixed-width); /* 页面固定宽度，不顶屏幕边缘 */
    margin: 0 auto; /* 居中对齐 */
    min-height: 100vh;
}

/* 顶部统计区域 - 法式精致卡片 */
.stats-container {
    background-color: var(--color-bg-primary);
    border-radius: var(--radius-lg);
    box-shadow: var(--shadow-sm);
    padding: 40px 32px;
    margin-bottom: 40px;
    text-align: center;
    transition: var(--transition-default);
    border: 1px solid rgba(0, 0, 0, 0.02); /* 极细边框，增加精致感 */
}

.stats-container:hover {
    box-shadow: var(--shadow-md);
}

.stats-title {
    font-size: 2.8rem;
    font-weight: 600;
    margin-bottom: 32px;
    color: var(--color-accent);
    letter-spacing: 2px; /* 字母间距，法式优雅 */
}

.days-stats {
    display: flex;
    gap: 60px;
    justify-content: center;
    margin-bottom: 32px;
    flex-wrap: wrap;
}

.day-item {
    font-size: 1.4rem;
    color: var(--color-text-secondary);
}

.day-number {
    font-size: 2.2rem;
    font-weight: 700;
    color: var(--color-accent);
    display: block; /* 独占一行，更整洁 */
    margin-bottom: 8px;
}

.birthday-tips {
    display: flex;
    gap: 60px;
    justify-content: center;
    flex-wrap: wrap;
    color: var(--color-text-secondary);
    font-size: 1.2rem;
    line-height: 1.6;
}

/* 功能按钮区域 - 法式简约按钮 */
.btn-container {
    display: flex;
    gap: 20px;
    justify-content: center;
    margin-bottom: 40px;
}

.btn {
    padding: 14px 32px;
    border: none;
    border-radius: var(--radius-sm);
    background-color: var(--color-accent);
    color: #FFFFFF;
    font-size: 1.1rem;
    font-weight: 500;
    cursor: pointer;
    transition: var(--transition-default);
    box-shadow: var(--shadow-sm);
    letter-spacing: 1px;
}

.btn:hover {
    transform: translateY(-3px);
    box-shadow: var(--shadow-md);
    background-color: #946F47; /* 略深的焦糖色，hover反馈 */
}

.btn-add-calendar {
    background-color: var(--color-anniversary-border);
}

.btn-add-calendar:hover {
    background-color: #C798A2;
}

.btn-save {
    background-color: var(--color-birthday-border);
}

.btn-save:hover {
    background-color: #8AA2B8;
}

.btn-load {
    background-color: var(--color-record-border);
}

.btn-load:hover {
    background-color: #C8B98A;
}

/* 标记类型选择区域 - 法式轻卡片 */
.tag-selector {
    background-color: var(--color-bg-primary);
    border-radius: var(--radius-md);
    box-shadow: var(--shadow-sm);
    padding: 24px 32px;
    margin-bottom: 40px;
    display: flex;
    gap: 24px;
    justify-content: center;
    flex-wrap: wrap;
    border: 1px solid rgba(0, 0, 0, 0.02);
}

.tag-item {
    padding: 12px 28px;
    border-radius: var(--radius-sm);
    cursor: pointer;
    border: 1px solid transparent;
    transition: var(--transition-default);
    user-select: none;
    font-size: 1.1rem;
    letter-spacing: 1px;
}

.tag-item.active {
    border-color: currentColor;
    box-shadow: var(--shadow-sm);
    background-color: rgba(255, 255, 255, 0.8); /* 激活态更亮，突出选择 */
}

.tag-anniversary {
    background-color: var(--color-anniversary);
    color: var(--color-anniversary-border);
}

.tag-menstruation {
    background-color: var(--color-menstruation);
    color: var(--color-menstruation-border);
}

.tag-birthday {
    background-color: var(--color-birthday);
    color: var(--color-birthday-border);
}

.tag-record {
    background-color: var(--color-record);
    color: var(--color-record-border);
}

/* 日历容器（新日历在上，旧日历在下）- 固定宽度，居中对齐 */
.calendar-container {
    display: flex;
    flex-direction: column;
    gap: 32px;
    width: 100%;
    max-width: var(--calendar-fixed-width);
    margin: 0 auto;
}

/* 单个日历面板 - 法式精致卡片 */
.calendar-panel {
    background-color: var(--color-bg-primary);
    border-radius: var(--radius-lg);
    box-shadow: var(--shadow-sm);
    padding: 32px 24px;
    transition: var(--transition-default);
    position: relative;
    border: 1px solid rgba(0, 0, 0, 0.02);
}

.calendar-panel:hover {
    box-shadow: var(--shadow-md);
}

/* 月删除按钮：日历面板左上角（法式精致×） */
.calendar-close {
    position: absolute;
    top: 20px;
    left: 20px;
    width: 28px;
    height: 28px;
    color: var(--color-close);
    cursor: pointer;
    font-size: 1.4rem;
    display: flex;
    align-items: center;
    justify-content: center;
    border-radius: 50%;
    transition: var(--transition-default);
    z-index: 5;
}

.calendar-close:hover {
    color: var(--color-close-hover);
    background-color: rgba(201, 138, 138, 0.05);
}

.calendar-title {
    font-size: 1.8rem;
    font-weight: 600;
    margin-bottom: 28px;
    padding-bottom: 16px;
    border-bottom: 1px solid var(--color-bg-tertiary);
    color: var(--color-text-primary);
    text-align: center;
    letter-spacing: 1px;
}

/* 日历表格 - 适配80px正方形格子，固定布局 */
.calendar-table {
    width: 100%;
    border-collapse: separate;
    border-spacing: 12px; /* 格子间距，法式留白感 */
    table-layout: fixed; /* 固定表格布局，防止格子变形 */
    margin: 0 auto;
}

.calendar-th {
    text-align: center;
    padding: 16px 0;
    color: var(--color-text-secondary);
    font-weight: 600;
    border-radius: var(--radius-sm);
    background-color: var(--color-bg-tertiary);
    width: var(--date-cell-size); /* 表头宽度与日期格子一致 */
    height: 48px;
    font-size: 1.1rem;
    letter-spacing: 1px;
}

.calendar-td {
    text-align: center;
    padding: 0;
    width: var(--date-cell-size); /* 单元格宽度固定80px */
    height: var(--date-cell-size); /* 单元格高度固定80px */
}

/* 日期单元格核心样式 - 固定80px×80px正方形，文字自适应 */
.date-cell {
    width: 100%;
    height: 100%;
    padding: 6px;
    border-radius: var(--radius-sm);
    background-color: var(--color-bg-tertiary);
    cursor: pointer;
    transition: var(--transition-default);
    position: relative;
    display: flex;
    flex-direction: column;
    justify-content: center;
    align-items: center;
    overflow: hidden; /* 隐藏超出格子的内容 */
}

.date-cell:hover {
    background-color: var(--color-bg-secondary);
    transform: translateY(-2px);
    box-shadow: var(--shadow-sm);
}

/* 日期数字：右上角固定 */
.date-number {
    position: absolute;
    top: 4px;
    right: 4px;
    font-size: 1.1rem;
    font-weight: 700;
    color: var(--color-text-secondary);
}

/* 标记内容容器：居中显示，文字自适应换行+缩小 */
.date-content {
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: center;
    width: 95%;
    height: 70%;
    text-align: center;
    overflow: hidden;
}

/* 标记标题+副标题：自适应字体大小，自动换行 */
.date-tag {
    font-size: 0.8rem;
    font-weight: 600;
    margin-bottom: 2px;
    color: currentColor;
    word-wrap: break-word; /* 自动换行 */
    word-break: break-all; /* 强制换行，防止长文字溢出 */
    line-height: 1.2; /* 行高紧凑，节省空间 */
    max-height: 40px; /* 最大高度，防止超出 */
    overflow: hidden;
    /* 文字自适应大小：超出则缩小 */
    font-size: clamp(0.6rem, 2vw, 0.8rem); /* 最小0.6rem，最大0.8rem，自适应中间值 */
}

.date-subtitle {
    font-size: 0.7rem;
    color: var(--color-text-secondary);
    word-wrap: break-word;
    word-break: break-all;
    line-height: 1.2;
    max-height: 30px;
    overflow: hidden;
    /* 文字自适应大小：超出则缩小 */
    font-size: clamp(0.5rem, 1.5vw, 0.7rem);
}

/* 取消按钮：左上角悬浮 */
.date-close {
    position: absolute;
    top: 4px;
    left: 4px;
    width: 18px;
    height: 18px;
    color: var(--color-close);
    cursor: pointer;
    font-size: 0.9rem;
    display: none;
    align-items: center;
    justify-content: center;
    border-radius: 50%;
    z-index: 2;
}

.date-cell:hover .date-close {
    display: flex;
}

.date-close:hover {
    color: var(--color-close-hover);
    background-color: rgba(0, 0, 0, 0.05);
}

/* 标记后的日期单元格样式 - 法式柔和配色，精致边框 */
.date-cell.anniversary {
    background-color: var(--color-anniversary);
    border: 1px solid var(--color-anniversary-border);
    color: var(--color-anniversary-border);
}

.date-cell.menstruation {
    background-color: var(--color-menstruation);
    border: 1px solid var(--color-menstruation-border);
    color: var(--color-menstruation-border);
}

.date-cell.birthday {
    background-color: var(--color-birthday);
    border: 1px solid var(--color-birthday-border);
    color: var(--color-birthday-border);
}

.date-cell.record {
    background-color: var(--color-record);
    border: 1px solid var(--color-record-border);
    color: var(--color-record-border);
}

/* 副标题编辑输入框 - 法式精致输入框 */
.subtitle-input {
    position: absolute;
    top: 50%;
    left: 50%;
    transform: translate(-50%, -50%);
    width: 90%;
    padding: 8px 6px;
    border: 1px solid var(--color-accent);
    border-radius: var(--radius-sm);
    outline: none;
    font-size: 0.7rem;
    z-index: 10;
    text-align: center;
    background-color: rgba(255, 255, 255, 0.95);
    box-shadow: var(--shadow-sm);
    color: var(--color-text-primary);
}

/* 响应式适配 - 固定宽度内的适配，保持法式布局完整性 */
@media (max-width: 1200px) {
    :root {
        --calendar-fixed-width: 900px; /* 屏幕小于1200px时，日历固定宽度改为900px */
    }

    .calendar-table {
        border-spacing: 8px;
    }

    .stats-title {
        font-size: 2.4rem;
    }

    .days-stats, .birthday-tips {
        gap: 40px;
    }
}

@media (max-width: 900px) {
    :root {
        --calendar-fixed-width: 700px; /* 屏幕小于900px时，日历固定宽度改为700px */
        --date-cell-size: 70px; /* 格子略缩小为70px×70px，保持布局 */
    }

    .stats-container {
        padding: 32px 24px;
    }

    .stats-title {
        font-size: 2rem;
    }

    .btn {
        padding: 12px 24px;
    }
}

@media (max-width: 700px) {
    :root {
        --calendar-fixed-width: 100%; /* 屏幕小于700px时，日历宽度自适应屏幕，不超过父容器 */
        --date-cell-size: 60px; /* 格子缩小为60px×60px，保证显示完整 */
    }

    .calendar-table {
        border-spacing: 4px;
    }

    .stats-title {
        font-size: 1.8rem;
    }

    .days-stats, .birthday-tips {
        gap: 20px;
    }

    .tag-selector {
        padding: 20px 16px;
        gap: 16px;
    }
}
</style>

</head>
<body>
    <!-- 顶部统计区域 -->
    <div class="stats-container">
        <h1 class="stats-title">我们的时光印记</h1>
        <div class="days-stats">
            <div class="day-item">已相遇 <span class="day-number" id="meet-days">0</span> 天</div>
            <div class="day-item">已相恋 <span class="day-number" id="love-days">0</span> 天</div>
        </div>
        <!-- 只保留生日倒计时 -->
        <div class="birthday-tips">
            <div id="next-chiyo-birthday">距离 千代的生日 还有 0 天</div>
            <div id="next-xiaode-birthday">距离 小德的生日 还有 0 天</div>
        </div>
    </div>

    <!-- 标记类型选择 -->
    <div class="tag-selector">
        <div class="tag-item tag-anniversary" data-tag="anniversary">纪念日</div>
        <div class="tag-item tag-menstruation" data-tag="menstruation">生理期</div>
        <div class="tag-item tag-birthday" data-tag="birthday">生日</div>
        <div class="tag-item tag-record" data-tag="record">记录</div>
    </div>

    <!-- 功能按钮 -->
    <div class="btn-container">
        <button class="btn btn-add-calendar" onclick="addNextCalendar()">新增下一个月日历</button>
        <button class="btn btn-save" onclick="saveToCloud()">保存日历到云端</button>
        <button class="btn btn-load" onclick="loadFromCloud()">从云端读取日历</button>
    </div>

    <!-- 日历容器（新日历在上，旧日历在下） -->
    <div class="calendar-container" id="calendar-wrapper"></div>

    <!-- Firebase 配置与核心逻辑 -->
    <script type="module">
        // 导入 Firebase
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import {
            getFirestore,
            collection,
            writeBatch,
            getDocs,
            doc
        } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

        // Firebase 配置（沿用原有项目配置）
        const firebaseConfig = {
            apiKey: "AIzaSyAhZtgaE8mL3GkxsIj17g1ha-Y5HG02C_A",
            authDomain: "weight-zqy.firebaseapp.com",
            projectId: "weight-zqy",
            storageBucket: "weight-zqy.firebasestorage.app",
            messagingSenderId: "710580530798",
            appId: "1:710580530798:web:30e48f089452364c02c07f"
        };

        // 初始化 Firebase
        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);
        const CALENDAR_KEY = "our_days_calendars_v1"; // 本地存储键

        // 核心常量配置
        const MEET_DATE = new Date(2025, 5, 7); // 相遇日期：2025年6月7日（月份从0开始）
        const LOVE_DATE = new Date(2025, 8, 21); // 相恋日期：2025年9月21日
        // 二人固定生日
        const BIRTHDAYS = {
            chiyo: { month: 9, day: 21, name: "千代" }, // 10月21日（月份从0开始）
            xiaode: { month: 8, day: 26, name: "小德" }  // 9月26日
        };
        let activeTag = null; // 当前选中的标记类型
        let calendarData = {
            calendars: [], // 存储日历列表（{ year: 2025, month: 5, dates: [] }）
            tags: {} // 存储日期标记（key: "2025-06-07", value: { type: "anniversary", subtitle: "" }）
        };

        // ========== 初始化与本地数据加载 ==========
        function init() {
            // 加载本地数据
            const localData = localStorage.getItem(CALENDAR_KEY);
            if (localData) {
                calendarData = JSON.parse(localData);
            } else {
                // 初始化默认日历：2025年6月
                addCalendar(2025, 5, true);
            }

            // 绑定标记选择事件
            bindTagSelector();

            // 更新统计数据
            updateStats();

            // 渲染所有日历
            renderAllCalendars();

            // 定时更新统计（每分钟）
            setInterval(updateStats, 60000);
        }

        // ========== 日历操作 ==========
        // 添加指定年月的日历（isInit：是否为初始化，不自动排序列表）
        function addCalendar(year, month, isInit = false) {
            // 检查是否已存在该年月的日历
            const exists = calendarData.calendars.some(c => c.year === year && c.month === month);
            if (exists) return;

            // 生成当月日期数据
            const dateCount = new Date(year, month + 1, 0).getDate(); // 当月天数
            const dates = Array.from({ length: dateCount }, (_, i) => i + 1);

            // 添加日历数据
            const newCalendar = { year, month, dates };
            calendarData.calendars.push(newCalendar);

            // 非初始化状态下，按「新日期在上」排序（年月倒序）
            if (!isInit) {
                calendarData.calendars.sort((a, b) => {
                    if (a.year !== b.year) return b.year - a.year;
                    return b.month - a.month;
                });
            }

            // 保存本地并渲染
            saveToLocal();
            if (!isInit) renderAllCalendars();

            // 自动生成周年标记（修复：仅对应月份生成）
            generateAnniversaryTags(year, month);
        }

        // 新增下一个月日历
        function addNextCalendar() {
            if (calendarData.calendars.length === 0) {
                addCalendar(2025, 5);
                return;
            }

            // 获取最新的日历（列表第一个，因为已排序）
            const latest = calendarData.calendars[0];
            let nextYear = latest.year;
            let nextMonth = latest.month + 1;

            // 跨年份处理
            if (nextMonth > 11) {
                nextYear += 1;
                nextMonth = 0;
            }

            // 添加下一个月日历
            addCalendar(nextYear, nextMonth);
        }

        // 删除指定年月的日历（带二次确认）
        function deleteCalendar(year, month) {
            // 二次确认弹窗，防止误触
            const isConfirm = confirm(`确定要删除 ${year}年${month + 1}月 的日历吗？删除后该月所有标记也会一并清除，且无法恢复！`);
            if (!isConfirm) return;

            // 1. 从日历列表中删除该月
            calendarData.calendars = calendarData.calendars.filter(c => !(c.year === year && c.month === month));

            // 2. 清除该月所有日期标记（格式：yyyy-mm-dd）
            const monthStr = String(month + 1).padStart(2, "0");
            const datePrefix = `${year}-${monthStr}-`;
            Object.keys(calendarData.tags).forEach(dateStr => {
                if (dateStr.startsWith(datePrefix)) {
                    delete calendarData.tags[dateStr];
                }
            });

            // 3. 保存本地并重新渲染
            saveToLocal();
            renderAllCalendars();
            updateStats();
            alert(`${year}年${month + 1}月 日历已成功删除！`);
        }

        // 渲染所有日历
        function renderAllCalendars() {
            const wrapper = document.getElementById("calendar-wrapper");
            wrapper.innerHTML = "";

            // 遍历日历列表，逐个渲染
            calendarData.calendars.forEach(calendar => {
                const calendarPanel = createCalendarPanel(calendar);
                wrapper.appendChild(calendarPanel);
            });
        }

        // 创建单个日历面板（新增月删除按钮）
        function createCalendarPanel(calendar) {
            const { year, month, dates } = calendar;
            const monthName = new Date(year, month).toLocaleDateString("zh-CN", { year: "numeric", month: "long" });

            // 创建日历面板容器
            const panel = document.createElement("div");
            panel.className = "calendar-panel";
            panel.dataset.year = year;
            panel.dataset.month = month;

            // 1. 添加月删除按钮（左上角×）
            const calendarCloseBtn = document.createElement("div");
            calendarCloseBtn.className = "calendar-close";
            calendarCloseBtn.innerText = "×";
            calendarCloseBtn.addEventListener("click", () => {
                deleteCalendar(year, month);
            });
            panel.appendChild(calendarCloseBtn);

            // 2. 日历标题
            const title = document.createElement("h2");
            title.className = "calendar-title";
            title.innerText = monthName;
            panel.appendChild(title);

            // 3. 日历表格
            const table = document.createElement("table");
            table.className = "calendar-table";

            // 表格头部（星期）
            const thead = document.createElement("thead");
            const weekTr = document.createElement("tr");
            const weeks = ["日", "一", "二", "三", "四", "五", "六"];
            weeks.forEach(week => {
                const th = document.createElement("th");
                th.className = "calendar-th";
                th.innerText = week;
                weekTr.appendChild(th);
            });
            thead.appendChild(weekTr);
            table.appendChild(thead);

            // 表格内容（日期）
            const tbody = document.createElement("tbody");
            const firstDay = new Date(year, month, 1).getDay(); // 当月1号是星期几（0=周日）
            let dateIndex = 0;
            let row = document.createElement("tr");

            // 填充月初空白单元格
            for (let i = 0; i < firstDay; i++) {
                const td = document.createElement("td");
                row.appendChild(td);
            }

            // 填充日期单元格
            dates.forEach(date => {
                // 新建行（每7个单元格一行）
                if (row.children.length >= 7) {
                    tbody.appendChild(row);
                    row = document.createElement("tr");
                }

                const td = document.createElement("td");
                td.className = "calendar-td";

                const dateStr = `${year}-${String(month + 1).padStart(2, "0")}-${String(date).padStart(2, "0")}`;
                const tagInfo = calendarData.tags[dateStr] || {};

                // 创建日期单元格内容
                const dateCell = document.createElement("div");
                dateCell.className = `date-cell ${tagInfo.type || ""}`;
                dateCell.dataset.date = dateStr;

                // 日期数字（右上角）
                const dateNumber = document.createElement("div");
                dateNumber.className = "date-number";
                dateNumber.innerText = date;
                dateCell.appendChild(dateNumber);

                // 取消按钮（仅标记单元格显示）
                if (tagInfo.type) {
                    const closeBtn = document.createElement("div");
                    closeBtn.className = "date-close";
                    closeBtn.innerText = "×";
                    closeBtn.addEventListener("click", (e) => {
                        e.stopPropagation(); // 阻止触发单元格点击事件
                        delete calendarData.tags[dateStr];
                        saveToLocal();
                        renderAllCalendars();
                        updateStats();
                    });
                    dateCell.appendChild(closeBtn);
                }

                // 标记内容容器（居中）
                const contentContainer = document.createElement("div");
                contentContainer.className = "date-content";
                dateCell.appendChild(contentContainer);

                // 标记标题 + 副标题（居中显示）
                if (tagInfo.type) {
                    const tagMap = {
                        anniversary: "纪念日",
                        menstruation: "生理期",
                        birthday: "生日",
                        record: "记录"
                    };
                    const tagTitle = document.createElement("div");
                    tagTitle.className = "date-tag";
                    tagTitle.innerText = tagInfo.anniversaryYear ? `${tagInfo.anniversaryYear}周年${tagMap[tagInfo.type]}` : tagMap[tagInfo.type];
                    contentContainer.appendChild(tagTitle);

                    // 副标题
                    const subtitle = document.createElement("div");
                    subtitle.className = "date-subtitle";
                    subtitle.innerText = tagInfo.subtitle || "";
                    contentContainer.appendChild(subtitle);
                }

                // 绑定单元格点击事件（标记/编辑副标题）
                dateCell.addEventListener("click", handleDateCellClick);
                td.appendChild(dateCell);
                row.appendChild(td);
            });

            // 填充月末空白单元格
            while (row.children.length < 7) {
                const emptyTd = document.createElement("td");
                row.appendChild(emptyTd);
            }
            tbody.appendChild(row);
            table.appendChild(tbody);
            panel.appendChild(table);

            return panel;
        }

        // ========== 标记与编辑功能 ==========
        // 绑定标记选择事件
        function bindTagSelector() {
            const tagItems = document.querySelectorAll(".tag-item");
            tagItems.forEach(item => {
                item.addEventListener("click", () => {
                    tagItems.forEach(t => t.classList.remove("active"));
                    item.classList.add("active");
                    activeTag = item.dataset.tag;
                });
            });
        }

        // 处理日期单元格点击
        function handleDateCellClick() {
            const dateStr = this.dataset.date;
            const tagInfo = calendarData.tags[dateStr] || {};

            // 有活跃标记：添加/更新标记
            if (activeTag) {
                calendarData.tags[dateStr] = {
                    type: activeTag,
                    subtitle: tagInfo.subtitle || "",
                    anniversaryYear: tagInfo.anniversaryYear || null
                };
                saveToLocal();
                renderAllCalendars();
                updateStats();
                return;
            }

            // 无活跃标记：编辑副标题（已有标记的单元格）
            if (tagInfo.type) {
                const cell = this;
                const contentContainer = cell.querySelector(".date-content");
                const currentSubtitle = tagInfo.subtitle || "";

                // 创建输入框
                const input = document.createElement("input");
                input.className = "subtitle-input";
                input.value = currentSubtitle;
                input.setAttribute("maxlength", "50");

                // 清空内容容器，添加输入框
                contentContainer.innerHTML = "";
                contentContainer.appendChild(input);
                input.focus();

                // 输入框失去焦点时保存
                input.addEventListener("blur", () => {
                    calendarData.tags[dateStr].subtitle = input.value.trim();
                    saveToLocal();
                    renderAllCalendars();
                });

                // 回车保存
                input.addEventListener("keydown", (e) => {
                    if (e.key === "Enter") input.blur();
                });
            }
        }

        // 生成周年标记（修复核心：仅在「相同月份」生成周年，解决每月都出现的BUG）
        function generateAnniversaryTags(targetYear, targetMonth) {
            const targetDateStrPrefix = `${targetYear}-${String(targetMonth + 1).padStart(2, "0")}`;

            // 遍历所有标记，找出纪念日和生日
            Object.entries(calendarData.tags).forEach(([dateStr, tagInfo]) => {
                if (!["anniversary", "birthday"].includes(tagInfo.type)) return;

                // 解析原始标记日期
                const [origYear, origMonth, origDay] = dateStr.split("-").map(Number);
                // 修复点1：仅当「目标月份 === 原始标记月份」时，才生成周年（核心逻辑）
                if (targetMonth + 1 !== origMonth) return; // 注意：origMonth是字符串转数字（1-12），targetMonth是索引（0-11）

                const targetDateStr = `${targetDateStrPrefix}-${String(origDay).padStart(2, "0")}`;

                // 计算周年数（仅当目标年月 >= 原始年月时生成）
                const targetDate = new Date(targetYear, targetMonth, origDay);
                const origDate = new Date(origYear, origMonth - 1, origDay); // origMonth转索引（0-11）
                if (targetDate < origDate) return;

                const anniversaryYear = targetYear - origYear;
                if (anniversaryYear <= 0) return;

                // 检查目标日期是否存在（当月有该日期）
                const targetMonthDays = new Date(targetYear, targetMonth + 1, 0).getDate();
                if (origDay > targetMonthDays) return;

                // 修复点2：避免重复生成（已存在该标记则跳过）
                if (calendarData.tags[targetDateStr]) return;

                // 添加周年标记
                calendarData.tags[targetDateStr] = {
                    type: tagInfo.type,
                    subtitle: tagInfo.subtitle || "",
                    anniversaryYear: anniversaryYear
                };
            });

            saveToLocal();
        }

        // ========== 统计数据更新 ==========
        function updateStats() {
            const now = new Date();

            // 计算已相遇/相恋天数
            const meetDays = Math.floor((now - MEET_DATE) / (1000 * 60 * 60 * 24));
            const loveDays = Math.floor((now - LOVE_DATE) / (1000 * 60 * 60 * 24));

            // 更新页面显示
            document.getElementById("meet-days").innerText = Math.max(0, meetDays);
            document.getElementById("love-days").innerText = Math.max(0, loveDays);

            // 更新二人的生日倒计时
            updateBirthdayTips(now);
        }

        // 更新二人的生日倒计时
        function updateBirthdayTips(now) {
            // 千代的生日
            const chiyoBirthday = new Date(now.getFullYear(), BIRTHDAYS.chiyo.month, BIRTHDAYS.chiyo.day);
            if (chiyoBirthday < now) chiyoBirthday.setFullYear(now.getFullYear() + 1);
            const chiyoDays = Math.floor((chiyoBirthday - now) / (1000 * 60 * 60 * 24)) + 1;
            document.getElementById("next-chiyo-birthday").innerText = `距离 ${BIRTHDAYS.chiyo.name}的生日 还有 ${chiyoDays} 天`;

            // 小德的生日
            const xiaodeBirthday = new Date(now.getFullYear(), BIRTHDAYS.xiaode.month, BIRTHDAYS.xiaode.day);
            if (xiaodeBirthday < now) xiaodeBirthday.setFullYear(now.getFullYear() + 1);
            const xiaodeDays = Math.floor((xiaodeBirthday - now) / (1000 * 60 * 60 * 24)) + 1;
            document.getElementById("next-xiaode-birthday").innerText = `距离 ${BIRTHDAYS.xiaode.name}的生日 还有 ${xiaodeDays} 天`;
        }

        // ========== 数据存储 ==========
        // 保存到本地 localStorage
        function saveToLocal() {
            localStorage.setItem(CALENDAR_KEY, JSON.stringify(calendarData));
        }

        // 保存到 Firebase 云端
        async function saveToCloudImpl() {
            try {
                const calendarsRef = collection(db, "our_days_calendars");

                // 步骤1：删除云端旧数据
                const oldSnap = await getDocs(calendarsRef);
                const batch = writeBatch(db);
                oldSnap.docs.forEach(docItem => {
                    batch.delete(docItem.ref);
                });
                await batch.commit();

                // 步骤2：批量上传最新日历数据
                const newBatch = writeBatch(db);
                const docRef = doc(calendarsRef);
                newBatch.set(docRef, {
                    ...calendarData,
                    updateTime: Date.now()
                });
                await newBatch.commit();

                alert("日历数据已成功保存到云端！");
            } catch (e) {
                alert(`保存失败：${e.message || JSON.stringify(e)}`);
                console.error("云端保存错误：", e);
            }
        }

        // 从 Firebase 云端读取
        async function loadFromCloudImpl() {
            try {
                const calendarsRef = collection(db, "our_days_calendars");
                const snap = await getDocs(calendarsRef);

                if (snap.empty) {
                    alert("云端暂无日历数据！");
                    return;
                }

                // 提取最新数据
                const cloudData = snap.docs[0].data();
                calendarData.calendars = cloudData.calendars || [];
                calendarData.tags = cloudData.tags || {};

                // 保存到本地并渲染
                saveToLocal();
                renderAllCalendars();
                updateStats();
                alert("日历数据已从云端成功读取！");
            } catch (e) {
                alert(`读取失败：${e.message || JSON.stringify(e)}`);
                console.error("云端读取错误：", e);
            }
        }

        // ========== 全局函数挂载 ==========
        window.addNextCalendar = addNextCalendar;
        window.saveToCloud = saveToCloudImpl;
        window.loadFromCloud = loadFromCloudImpl;

        // ========== 页面初始化 ==========
        init();
    </script>
</body>
</html>
