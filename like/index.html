<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>千代 & 小德 饮食偏好记录</title>
   <style>
:root {
  /* 米其林餐盘风配色 - 柔和低饱和，贴近食材原色 */
  --color-bg-main: #f9f7f4; /* 米白色背景，类似餐盘底 */
  --color-panel: #ffffff; /* 面板底色，干净通透 */
  --color-love-light: #e8f4f8; /* 爱吃贴纸 - 淡青，像青柠点缀 */
  --color-love-border: #82c3ec;
  --color-love-text: #2d7d9a;
  --color-hate-light: #fdf2f8; /* 不爱吃贴纸 - 淡粉，像樱花粉 */
  --color-hate-border: #fec5e5;
  --color-hate-text: #9a2d5a;
  --color-common-light: #eaf6fa; /* 共同偏好 - 浅蓝绿，像薄荷 */
  --color-common-border: #b2f0e1;
  --color-common-text: #2d9a7c;
  --color-text-title: #4a4a4a; /* 标题灰，不刺眼 */
  --color-text-body: #6e6e6e; /* 正文灰，柔和易读 */
  --color-divider: #f0e9e0; /* 分隔线，像餐盘边缘 */
  --color-trash: #e5704b; /* 垃圾桶 - 暖橙红，像干玫瑰 */
  --color-trash-hover: #d45a30;
  --color-btn-love: #82c3ec;
  --color-btn-love-hover: #5babd9;
  --color-btn-hate: #fec5e5;
  --color-btn-hate-hover: #faa7cd;
  --color-btn-cloud: #a8d8ea;
  --color-btn-cloud-hover: #79c2d0;

  /* 圆角与阴影 - 模拟餐盘弧度和光影 */
  --radius-xs: 4px;
  --radius-sm: 8px;
  --radius-md: 12px;
  --radius-lg: 20px;
  --radius-circle: 50%;
  --shadow-xs: 0 1px 3px rgba(0,0,0,0.05);
  --shadow-sm: 0 3px 8px rgba(0,0,0,0.08);
  --shadow-md: 0 5px 15px rgba(0,0,0,0.1);

  /* 过渡动效 - 游戏化轻盈反馈 */
  --transition-fast: all 0.15s ease-out;
  --transition-normal: all 0.25s ease-in-out;
}

* {
  margin: 0;
  padding: 0;
  box-sizing: border-box;
  font-family: "Helvetica Neue", "PingFang SC", "Microsoft YaHei", sans-serif;
}

body {
  background-color: var(--color-bg-main);
  color: var(--color-text-body);
  padding: 32px 20px;
  max-width: 1700px;
  margin: 0 auto;
  min-height: 100vh;
  line-height: 1.5;
}

h1 {
  text-align: center;
  margin-bottom: 48px;
  font-weight: 500;
  font-size: 2.8rem;
  color: var(--color-text-title);
  letter-spacing: -0.03em;
  position: relative;
}

h1::after {
  content: "";
  display: block;
  width: 80px;
  height: 3px;
  background-color: var(--color-divider);
  margin: 16px auto 0;
  border-radius: var(--radius-xs);
}

/* 云端按钮 - 像餐盘旁的调味罐 */
.cloud-buttons {
  display: flex;
  gap: 20px;
  justify-content: center;
  margin-bottom: 40px;
}

.cloud-buttons button {
  padding: 14px 30px;
  border: none;
  border-radius: var(--radius-md);
  background-color: var(--color-btn-cloud);
  color: var(--color-text-title);
  font-size: 1rem;
  font-weight: 500;
  cursor: pointer;
  transition: var(--transition-normal);
  box-shadow: var(--shadow-xs);
}

.cloud-buttons button:hover {
  background-color: var(--color-btn-cloud-hover);
  box-shadow: var(--shadow-sm);
  transform: translateY(-2px);
}

/* 三栏布局容器 - 像三联餐盘 */
.preference-container {
  display: flex;
  gap: 30px;
  width: 100%;
  margin-bottom: 50px;
}

/* 左右个人面板 - 独立餐盘样式 */
.person-panel {
  flex: 1;
  background-color: var(--color-panel);
  border-radius: var(--radius-lg);
  box-shadow: var(--shadow-xs);
  padding: 32px;
  transition: var(--transition-normal);
  border: 1px solid var(--color-divider);
}

.person-panel:hover {
  box-shadow: var(--shadow-sm);
  transform: translateY(-3px);
}

.person-title {
  font-size: 1.9rem;
  font-weight: 500;
  margin-bottom: 28px;
  padding-bottom: 20px;
  border-bottom: 2px solid var(--color-divider);
  color: var(--color-text-title);
  text-align: center;
}

/* 中间共同面板 - 视觉焦点餐盘 */
.common-panel {
  flex: 1;
  background-color: var(--color-panel);
  border-radius: var(--radius-lg);
  box-shadow: var(--shadow-sm);
  padding: 32px;
  transition: var(--transition-normal);
  border: 1px solid var(--color-common-border);
  position: relative;
}

.common-panel::before {
  content: "";
  position: absolute;
  top: -5px;
  left: -5px;
  right: -5px;
  bottom: -5px;
  border: 1px dashed var(--color-common-border);
  border-radius: var(--radius-lg);
  z-index: -1;
  opacity: 0.5;
}

.common-panel:hover {
  box-shadow: var(--shadow-md);
  transform: translateY(-3px);
}

.common-title {
  font-size: 1.9rem;
  font-weight: 500;
  margin-bottom: 28px;
  padding-bottom: 20px;
  border-bottom: 2px solid var(--color-common-border);
  color: var(--color-common-text);
  text-align: center;
}

/* 偏好区域 - 餐盘分区 */
.preference-sections {
  display: flex;
  flex-direction: column;
  gap: 28px;
  width: 100%;
}

.preference-section {
  min-height: 300px;
  background-color: var(--color-bg-main);
  border-radius: var(--radius-md);
  padding: 24px;
  position: relative;
  transition: var(--transition-normal);
  border: 1px solid var(--color-divider);
}

.preference-section:hover {
  background-color: #faf7f2;
}

/* 区域标题 - 像餐盘分区标签 */
.section-title-person {
  font-size: 1.2rem;
  font-weight: 500;
  margin-bottom: 24px;
  padding: 8px 0;
  border-radius: var(--radius-xs);
  text-align: center;
}

.section-title-love {
  background-color: var(--color-love-light);
  color: var(--color-love-text);
}

.section-title-hate {
  background-color: var(--color-hate-light);
  color: var(--color-hate-text);
}

.section-title-common {
  font-size: 1.2rem;
  font-weight: 500;
  margin-bottom: 24px;
  padding: 8px 0;
  border-radius: var(--radius-xs);
  color: var(--color-common-text);
  text-align: center;
  background-color: var(--color-common-light);
}

/* 贴纸样式 - 游戏化便利贴，像餐盘装饰 */
.preference-sticker {
  background-color: var(--color-love-light);
  border: 2px solid var(--color-love-border);
  border-radius: var(--radius-sm);
  padding: 16px 22px;
  margin-bottom: 18px;
  box-shadow: var(--shadow-xs);
  cursor: grab;
  user-select: none;
  transition: var(--transition-fast);
  position: relative;
  z-index: 1;
  color: var(--color-love-text);
  font-size: 1rem;
}

/* 贴纸倾斜角 - 游戏化随性 */
.preference-sticker:nth-child(odd) {
  transform: rotate(-1deg);
}

.preference-sticker:nth-child(even) {
  transform: rotate(1deg);
}

.preference-sticker:active {
  cursor: grabbing;
  box-shadow: var(--shadow-sm);
  transform: scale(1.05) rotate(0deg);
  z-index: 10;
}

.preference-sticker.hate {
  background-color: var(--color-hate-light);
  border-color: var(--color-hate-border);
  color: var(--color-hate-text);
}

/* 共同贴纸 - 更精致的装饰感 */
.preference-sticker.common {
  background-color: var(--color-common-light);
  border-color: var(--color-common-border);
  color: var(--color-common-text);
  cursor: default;
  box-shadow: 0 2px 8px rgba(178, 240, 225, 0.3);
}

.preference-sticker.common:active {
  transform: none;
  box-shadow: 0 2px 8px rgba(178, 240, 225, 0.3);
}

/* 输入框与按钮 - 像餐盘小工具 */
.preference-input-container {
  display: flex;
  gap: 14px;
  width: 100%;
  margin-top: 20px;
}

input[type="text"] {
  flex: 1;
  padding: 14px 24px;
  border: 2px solid var(--color-divider);
  border-radius: var(--radius-md);
  font-size: 1rem;
  outline: none;
  transition: var(--transition-fast);
  background-color: var(--color-bg-main);
  color: var(--color-text-body);
}

input[type="text"]:focus {
  border-color: var(--color-love-border);
  background-color: var(--color-panel);
  box-shadow: 0 0 0 3px rgba(130, 195, 236, 0.1);
}

.btn-love {
  padding: 14px 28px;
  border: none;
  border-radius: var(--radius-md);
  background-color: var(--color-btn-love);
  color: var(--color-love-text);
  font-size: 1rem;
  font-weight: 500;
  cursor: pointer;
  transition: var(--transition-normal);
}

.btn-love:hover {
  background-color: var(--color-btn-love-hover);
  transform: translateY(-2px);
}

.btn-hate {
  padding: 14px 28px;
  border: none;
  border-radius: var(--radius-md);
  background-color: var(--color-btn-hate);
  color: var(--color-hate-text);
  font-size: 1rem;
  font-weight: 500;
  cursor: pointer;
  transition: var(--transition-normal);
}

.btn-hate:hover {
  background-color: var(--color-btn-hate-hover);
  transform: translateY(-2px);
}

/* 垃圾桶 - 像餐桌旁的收纳罐 */
.trash-bin {
  position: fixed;
  left: 50%;
  bottom: 40px;
  transform: translateX(-50%);
  width: 100px;
  height: 100px;
  background-color: var(--color-trash);
  border-radius: var(--radius-circle);
  display: flex;
  align-items: center;
  justify-content: center;
  color: var(--color-panel);
  font-size: 2.8rem;
  box-shadow: var(--shadow-sm);
  opacity: 0.85;
  transition: var(--transition-normal);
  z-index: 20;
}

.trash-bin.active {
  opacity: 1;
  transform: translateX(-50%) scale(1.1);
  background-color: var(--color-trash-hover);
  box-shadow: var(--shadow-md);
}

/* 拖拽占位符 - 虚线餐盘格 */
.placeholder {
  background-color: rgba(232, 244, 248, 0.4);
  border: 2px dashed var(--color-love-border);
  border-radius: var(--radius-sm);
  padding: 16px 22px;
  margin-bottom: 18px;
  height: 62px;
}

.placeholder.hate-placeholder {
  background-color: rgba(253, 242, 248, 0.4);
  border-color: var(--color-hate-border);
}

/* 响应式适配 - 不同尺寸餐盘布局 */
@media (max-width: 1200px) {
  .preference-container {
    flex-direction: column;
  }
  .common-panel {
    order: -1; /* 共同区域置顶 */
  }
  .person-title, .common-title {
    font-size: 1.7rem;
  }
  h1 {
    font-size: 2.2rem;
  }
}

@media (max-width: 768px) {
  .preference-section {
    min-height: 250px;
  }
  .trash-bin {
    width: 80px;
    height: 80px;
    font-size: 2.2rem;
  }
  .cloud-buttons {
    flex-direction: column;
    width: 80%;
    margin: 0 auto 30px;
  }
}
</style>

    <!-- 引入 Font Awesome 用于垃圾桶图标 -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
</head>
<body>
    <h1>千代 & 小德 饮食偏好记录</h1>

    <!-- 云端保存/读取按钮 -->
    <div class="cloud-buttons">
        <button onclick="saveToCloud()">保存偏好到云端</button>
        <button onclick="loadFromCloud()">从云端读取偏好</button>
    </div>

    <!-- 饮食偏好主容器（三栏布局） -->
    <div class="preference-container">
        <!-- 左侧：千代的偏好面板 -->
        <div class="person-panel">
            <h2 class="person-title">千代</h2>
            <div class="preference-sections">
                <!-- 千代：爱吃的 -->
                <div class="preference-section" id="chiyo-love" data-type="love" data-person="chiyo">
                    <h3 class="section-title-person section-title-love">爱吃的</h3>
                </div>
                <!-- 千代：输入框（爱吃） -->
                <div class="preference-input-container">
                    <input type="text" id="chiyo-love-input" placeholder="输入千代爱吃的食物...">
                    <button class="btn-love" onclick="addPreference('chiyo', 'love')">添加</button>
                </div>

                <!-- 千代：不爱吃的 -->
                <div class="preference-section" id="chiyo-hate" data-type="hate" data-person="chiyo">
                    <h3 class="section-title-person section-title-hate">不爱吃的</h3>
                </div>
                <!-- 千代：输入框（不爱吃） -->
                <div class="preference-input-container">
                    <input type="text" id="chiyo-hate-input" placeholder="输入千代不爱吃的食物...">
                    <button class="btn-hate" onclick="addPreference('chiyo', 'hate')">添加</button>
                </div>
            </div>
        </div>

        <!-- 中间：共同偏好面板（自动汇总，不可输入） -->
        <div class="common-panel">
            <h2 class="common-title">二人共同偏好</h2>
            <div class="preference-sections">
                <!-- 共同：都爱吃的 -->
                <div class="preference-section" id="common-love" data-type="common-love">
                    <h3 class="section-title-common">都爱吃的</h3>
                </div>

                <!-- 共同：都不爱吃的 -->
                <div class="preference-section" id="common-hate" data-type="common-hate">
                    <h3 class="section-title-common">都不爱吃的</h3>
                </div>
            </div>
        </div>

        <!-- 右侧：小德的偏好面板 -->
        <div class="person-panel">
            <h2 class="person-title">小德</h2>
            <div class="preference-sections">
                <!-- 小德：爱吃的 -->
                <div class="preference-section" id="xiaode-love" data-type="love" data-person="xiaode">
                    <h3 class="section-title-person section-title-love">爱吃的</h3>
                </div>
                <!-- 小德：输入框（爱吃） -->
                <div class="preference-input-container">
                    <input type="text" id="xiaode-love-input" placeholder="输入小德爱吃的食物...">
                    <button class="btn-love" onclick="addPreference('xiaode', 'love')">添加</button>
                </div>

                <!-- 小德：不爱吃的 -->
                <div class="preference-section" id="xiaode-hate" data-type="hate" data-person="xiaode">
                    <h3 class="section-title-person section-title-hate">不爱吃的</h3>
                </div>
                <!-- 小德：输入框（不爱吃） -->
                <div class="preference-input-container">
                    <input type="text" id="xiaode-hate-input" placeholder="输入小德不爱吃的食物...">
                    <button class="btn-hate" onclick="addPreference('xiaode', 'hate')">添加</button>
                </div>
            </div>
        </div>
    </div>

    <!-- 垃圾桶 -->
    <div class="trash-bin" id="trash-bin">
        <i class="fas fa-trash"></i>
    </div>

    <!-- Firebase 配置与核心逻辑 -->
    <script type="module">
        // 导入 Firebase
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import {
            getFirestore,
            collection,
            writeBatch,
            getDocs,
            doc
        } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

        // Firebase 配置（沿用原有项目配置）
        const firebaseConfig = {
            apiKey: "AIzaSyAhZtgaE8mL3GkxsIj17g1ha-Y5HG02C_A",
            authDomain: "weight-zqy.firebaseapp.com",
            projectId: "weight-zqy",
            storageBucket: "weight-zqy.firebasestorage.app",
            messagingSenderId: "710580530798",
            appId: "1:710580530798:web:30e48f089452364c02c07f"
        };

        // 初始化 Firebase
        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);
        const PREFERENCE_KEY = "food_preference_v1"; // 本地存储键

        // 初始化本地数据结构
        let preferenceData = JSON.parse(localStorage.getItem(PREFERENCE_KEY) || JSON.stringify({
            chiyo: { love: [], hate: [] },
            xiaode: { love: [], hate: [] }
        }));

        // 全局拖拽相关变量
        let draggingSticker = null;
        let placeholder = null;
        let currentSection = null;

        // ========== 本地数据操作 ==========
        // 保存到本地 localStorage
        function saveToLocal() {
            localStorage.setItem(PREFERENCE_KEY, JSON.stringify(preferenceData));
        }

        // 计算共同偏好（核心：找出二人相同的食物）
        function calculateCommonPreferences() {
            // 共同爱吃：千代爱吃 ∩ 小德爱吃
            const commonLove = preferenceData.chiyo.love
                .map(item => item.content)
                .filter(content => preferenceData.xiaode.love.some(item => item.content === content));

            // 共同不爱吃：千代不爱吃 ∩ 小德不爱吃
            const commonHate = preferenceData.chiyo.hate
                .map(item => item.content)
                .filter(content => preferenceData.xiaode.hate.some(item => item.content === content));

            return { commonLove, commonHate };
        }

        // 渲染所有内容（个人偏好 + 共同偏好）
        function renderAll() {
            // 1. 清空所有面板内容
            clearAllSections();

            // 2. 渲染个人偏好（千代 + 小德）
            renderPersonPreferences("chiyo");
            renderPersonPreferences("xiaode");

            // 3. 计算并渲染共同偏好
            renderCommonPreferences();
        }

        // 清空所有区域内容
        function clearAllSections() {
            // 个人区域
            document.getElementById("chiyo-love").innerHTML = '<h3 class="section-title-person section-title-love">爱吃的</h3>';
            document.getElementById("chiyo-hate").innerHTML = '<h3 class="section-title-person section-title-hate">不爱吃的</h3>';
            document.getElementById("xiaode-love").innerHTML = '<h3 class="section-title-person section-title-love">爱吃的</h3>';
            document.getElementById("xiaode-hate").innerHTML = '<h3 class="section-title-person section-title-hate">不爱吃的</h3>';

            // 共同区域
            document.getElementById("common-love").innerHTML = '<h3 class="section-title-common">都爱吃的</h3>';
            document.getElementById("common-hate").innerHTML = '<h3 class="section-title-common">都不爱吃的</h3>';
        }

        // 渲染个人偏好
        function renderPersonPreferences(person) {
            // 渲染爱吃的
            preferenceData[person].love.forEach((item, index) => {
                const sticker = createPreferenceSticker(person, "love", index, item);
                document.getElementById(`${person}-love`).appendChild(sticker);
            });

            // 渲染不爱吃的
            preferenceData[person].hate.forEach((item, index) => {
                const sticker = createPreferenceSticker(person, "hate", index, item);
                document.getElementById(`${person}-hate`).appendChild(sticker);
            });
        }

        // 渲染共同偏好
        function renderCommonPreferences() {
            const { commonLove, commonHate } = calculateCommonPreferences();

            // 渲染共同爱吃的
            commonLove.forEach(content => {
                const sticker = createCommonSticker(content, "love");
                document.getElementById("common-love").appendChild(sticker);
            });

            // 渲染共同不爱吃的
            commonHate.forEach(content => {
                const sticker = createCommonSticker(content, "hate");
                document.getElementById("common-hate").appendChild(sticker);
            });
        }

        // 创建个人偏好贴纸
        function createPreferenceSticker(person, type, index, item) {
            const sticker = document.createElement("div");
            sticker.className = `preference-sticker ${type === 'hate' ? 'hate' : ''}`;
            sticker.dataset.person = person;
            sticker.dataset.type = type;
            sticker.dataset.index = index;
            sticker.innerText = item.content;

            // 绑定拖拽事件
            sticker.addEventListener("mousedown", startDrag);
            sticker.addEventListener("touchstart", startDrag, { passive: true });

            return sticker;
        }

        // 创建共同偏好贴纸（不可拖拽）
        function createCommonSticker(content, type) {
            const sticker = document.createElement("div");
            sticker.className = `preference-sticker common ${type === 'hate' ? 'hate' : ''}`;
            sticker.innerText = content;
            return sticker;
        }

        // 添加新偏好
        function addPreference(person, type) {
            const input = document.getElementById(`${person}-${type}-input`);
            const content = input.value.trim();
            if (!content) return;

            // 避免重复添加（个人内部去重）
            const isDuplicate = preferenceData[person][type].some(item => item.content === content);
            if (isDuplicate) {
                alert(`已经添加过「${content}」啦～`);
                input.value = "";
                return;
            }

            // 添加到本地数据
            preferenceData[person][type].push({
                content: content,
                createTime: Date.now()
            });

            // 保存并重新渲染
            saveToLocal();
            renderAll();

            // 清空输入框
            input.value = "";
        }

        // 删除偏好
        function deletePreference(person, type, index) {
            preferenceData[person][type].splice(index, 1);
            saveToLocal();
            renderAll();
        }

        // ========== 拖拽功能实现 ==========
        // 开始拖拽
        function startDrag(e) {
            draggingSticker = this;
            currentSection = draggingSticker.parentElement;

            // 跳过共同偏好贴纸（不可拖拽）
            if (draggingSticker.classList.contains("common")) return;

            // 创建占位符
            placeholder = document.createElement("div");
            placeholder.className = `placeholder ${currentSection.dataset.type === 'hate' ? 'hate-placeholder' : ''}`;
            draggingSticker.parentNode.insertBefore(placeholder, draggingSticker);

            // 隐藏原贴纸（通过透明度，保持布局）
            draggingSticker.style.opacity = "0.6";

            // 绑定移动和结束事件
            document.addEventListener("mousemove", dragMove);
            document.addEventListener("mouseup", endDrag);
            document.addEventListener("touchmove", dragMove, { passive: true });
            document.addEventListener("touchend", endDrag);
        }

        // 拖拽移动
        function dragMove(e) {
            if (!draggingSticker || draggingSticker.classList.contains("common")) return;

            // 兼容鼠标和触摸事件
            let clientX = e.clientX || (e.touches && e.touches[0].clientX);
            let clientY = e.clientY || (e.touches && e.touches[0].clientY);

            // 设置贴纸跟随鼠标/触摸点
            draggingSticker.style.position = "absolute";
            draggingSticker.style.left = `${clientX - draggingSticker.offsetWidth / 2}px`;
            draggingSticker.style.top = `${clientY - draggingSticker.offsetHeight / 2}px`;

            // 检测是否进入垃圾桶
            const trashBin = document.getElementById("trash-bin");
            const trashRect = trashBin.getBoundingClientRect();
            const isOverTrash = clientX >= trashRect.left && clientX <= trashRect.right &&
                                clientY >= trashRect.top && clientY <= trashRect.bottom;

            // 切换垃圾桶激活状态
            if (isOverTrash) {
                trashBin.classList.add("active");
            } else {
                trashBin.classList.remove("active");
            }

            // 检测是否进入个人偏好区域（仅允许在个人同类型区域拖拽）
            const personSections = document.querySelectorAll(".preference-section[data-person]");
            personSections.forEach(section => {
                const rect = section.getBoundingClientRect();
                if (clientX >= rect.left && clientX <= rect.right && clientY >= rect.top && clientY <= rect.bottom) {
                    if (section !== currentSection) {
                        currentSection = section;
                        section.appendChild(placeholder);
                    }
                }
            });
        }

        // 结束拖拽
        function endDrag(e) {
            if (!draggingSticker || draggingSticker.classList.contains("common")) return;

            // 恢复贴纸样式
            draggingSticker.style.opacity = "1";
            draggingSticker.style.position = "";
            draggingSticker.style.left = "";
            draggingSticker.style.top = "";

            // 检测是否删除（放入垃圾桶）
            const trashBin = document.getElementById("trash-bin");
            const trashRect = trashBin.getBoundingClientRect();
            let clientX = e.clientX || (e.changedTouches && e.changedTouches[0].clientX);
            let clientY = e.clientY || (e.changedTouches && e.changedTouches[0].clientY);
            const isOverTrash = clientX >= trashRect.left && clientX <= trashRect.right &&
                                clientY >= trashRect.top && clientY <= trashRect.bottom;

            if (isOverTrash) {
                // 删除偏好
                const person = draggingSticker.dataset.person;
                const type = draggingSticker.dataset.type;
                const index = parseInt(draggingSticker.dataset.index);
                deletePreference(person, type, index);
            } else {
                // 恢复布局（将贴纸放回占位符位置）
                if (currentSection && placeholder) {
                    currentSection.replaceChild(draggingSticker, placeholder);
                }
            }

            // 清空拖拽变量
            draggingSticker = null;
            placeholder = null;
            currentSection = null;
            trashBin.classList.remove("active");

            // 解绑事件
            document.removeEventListener("mousemove", dragMove);
            document.removeEventListener("mouseup", endDrag);
            document.removeEventListener("touchmove", dragMove);
            document.removeEventListener("touchend", endDrag);
        }

        // ========== 云端数据同步 ==========
        // 保存到 Firebase 云端
        async function saveToCloudImpl() {
            try {
                const preferencesRef = collection(db, "food_preferences");

                // 步骤1：删除云端旧数据
                const oldSnap = await getDocs(preferencesRef);
                const batch = writeBatch(db);
                oldSnap.docs.forEach(docItem => {
                    batch.delete(docItem.ref);
                });
                await batch.commit();

                // 步骤2：批量上传最新偏好数据
                const newBatch = writeBatch(db);
                const docRef = doc(preferencesRef); // 生成唯一文档
                newBatch.set(docRef, {
                    ...preferenceData,
                    updateTime: Date.now()
                });
                await newBatch.commit();

                alert("饮食偏好数据已成功保存到云端！");
            } catch (e) {
                alert(`保存失败：${e.message || JSON.stringify(e)}`);
                console.error("云端保存错误：", e);
            }
        }

        // 从 Firebase 云端读取
        async function loadFromCloudImpl() {
            try {
                const preferencesRef = collection(db, "food_preferences");
                const snap = await getDocs(preferencesRef);

                if (snap.empty) {
                    alert("云端暂无饮食偏好数据！");
                    return;
                }

                // 提取最新数据
                const cloudData = snap.docs[0].data();
                preferenceData.chiyo = cloudData.chiyo || { love: [], hate: [] };
                preferenceData.xiaode = cloudData.xiaode || { love: [], hate: [] };

                // 保存到本地并渲染
                saveToLocal();
                renderAll();
                alert("饮食偏好数据已从云端成功读取！");
            } catch (e) {
                alert(`读取失败：${e.message || JSON.stringify(e)}`);
                console.error("云端读取错误：", e);
            }
        }

        // ========== 全局函数挂载（解决模块作用域问题） ==========
        window.addPreference = addPreference;
        window.saveToCloud = saveToCloudImpl;
        window.loadFromCloud = loadFromCloudImpl;

        // ========== 页面初始化 ==========
        renderAll();
    </script>
</body>
</html>
