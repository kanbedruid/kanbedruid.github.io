<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>千代 & 小德 饮食偏好记录</title>
 <style>
:root {
  /* ===== 法式高级莫兰迪配色（柔和优雅，贴合女生审美） ===== */
  --bg-paper: #F9F7F5; /* 法式米白背景纸 */
  --bg-canvas: #FCFBF9; /* 浅画布色 */
  --bg-panel: #FFFFFF; /* 面板纯白 */
  --bg-soft: #F5F2EF; /* 法式浅灰柔色 */

  --ink-main: #2C2825; /* 法式深棕文字（替代纯黑，更高级） */
  --ink-sub: #7A726B; /* 浅棕次级文字 */
  --ink-fade: #B0A8A0; /* 淡棕提示文字 */

  /* 爱吃 / 不爱吃 / 共同 - 法式莫兰迪柔和色调 */
  --love-bg: #E6F0F8; /* 法式雾蓝（爱吃） */
  --love-border: #9AB3C9; /* 深一点的雾蓝边框 */
  --love-hover: #D7E4F1; /* 雾蓝hover色 */

  --hate-bg: #F9E6E8; /* 法式柔粉（不爱吃） */
  --hate-border: #C98A8A; /* 深一点的柔粉边框 */
  --hate-hover: #F0D9DB; /* 柔粉hover色 */

  --common-bg: #F8F5E6; /* 法式米黄（共同） */
  --common-border: #D9CC9A; /* 深一点的米黄边框 */

  /* 法式强调色（焦糖金棕，提升高级感） */
  --accent-warm: #A67C52;
  --accent-light: #E8D9C7;

  /* 法式柔和阴影（低饱和，不突兀） */
  --shadow-soft: 0 4px 16px rgba(0, 0, 0, 0.06);
  --shadow-hover: 0 8px 24px rgba(0, 0, 0, 0.09);

  /* 法式小圆角（精致不夸张） */
  --radius-lg: 16px;
  --radius-md: 12px;
  --radius-sm: 8px;
  --radius-circle: 999px;

  /* 顺滑过渡 */
  --transition: all .3s ease-in-out;
}

* {
  box-sizing: border-box;
  /* 法式衬线字体（打造优雅氛围，兼容中文字体） */
  font-family: "Garamond", "Times New Roman", "Noto Serif SC", serif;
}

body {
  margin: 0;
  padding: 40px 24px 120px;
  /* 法式渐变背景，增加层次感但不刺眼 */
  background:
    radial-gradient(1200px 600px at 20% 0%, #FFFFFF 0%, transparent 60%),
    var(--bg-paper);
  color: var(--ink-main);
  min-height: 100vh;
}

/* ===== 法式标题（优雅衬线，字母间距） ===== */
h1 {
  text-align: center;
  font-weight: 600;
  font-size: 2.8rem;
  margin-bottom: 40px;
  letter-spacing: 2px; /* 法式字母间距，提升优雅感 */
  color: var(--accent-warm);
}

/* ===== 云端按钮（法式简约卡片按钮） ===== */
.cloud-buttons {
  display: flex;
  justify-content: center;
  gap: 24px;
  margin-bottom: 48px;
  flex-wrap: wrap;
}

.cloud-buttons button {
  padding: 14px 32px;
  border-radius: var(--radius-sm);
  border: 1px solid var(--accent-light);
  background: var(--bg-panel);
  color: var(--ink-main);
  font-size: 1.05rem;
  cursor: pointer;
  transition: var(--transition);
  box-shadow: var(--shadow-soft);
  letter-spacing: 1px;
}

.cloud-buttons button:hover {
  background: var(--accent-light);
  transform: translateY(-3px);
  box-shadow: var(--shadow-hover);
  border-color: var(--accent-warm);
}

/* ===== 三栏整体布局（保留响应式，增加法式留白） ===== */
.preference-container {
  display: grid;
  grid-template-columns: 1.1fr 0.8fr 1.1fr;
  gap: 32px;
  max-width: 1500px;
  margin: 0 auto;
}

/* ===== 面板（法式精致卡片，柔和阴影+圆角） ===== */
.person-panel,
.common-panel {
  background: var(--bg-panel);
  border-radius: var(--radius-lg);
  padding: 32px 28px 36px;
  box-shadow: var(--shadow-soft);
  transition: var(--transition);
  border: 1px solid rgba(0, 0, 0, 0.02); /* 极细边框，增加精致感 */
}

.person-panel:hover,
.common-panel:hover {
  box-shadow: var(--shadow-hover);
  transform: translateY(-2px);
}

/* ===== 面板标题（法式优雅，强调色点缀） ===== */
.person-title {
  font-size: 1.8rem;
  font-weight: 600;
  margin-bottom: 24px;
  letter-spacing: 1px;
  color: var(--ink-main);
  padding-bottom: 16px;
  border-bottom: 1px solid var(--bg-soft); /* 法式分割线，增加层次感 */
}

.common-title {
  font-size: 1.7rem;
  font-weight: 600;
  text-align: center;
  margin-bottom: 28px;
  color: var(--accent-warm);
  letter-spacing: 1px;
  padding-bottom: 16px;
  border-bottom: 1px solid var(--bg-soft);
}

/* ===== 偏好区域（法式柔色卡片，留白充足） ===== */
.preference-sections {
  display: flex;
  flex-direction: column;
  gap: 26px;
}

.preference-section {
  background: var(--bg-soft);
  border-radius: var(--radius-md);
  padding: 20px 20px 26px;
  min-height: 220px;
  transition: var(--transition);
}

.preference-section:hover {
  background: var(--accent-light);
  opacity: 0.95;
}

/* ===== 区域标题（法式小写字母，间距优雅） ===== */
.section-title-person,
.section-title-common {
  text-align: center;
  font-size: 1.05rem;
  letter-spacing: 0.15em; /* 法式字母间距，提升质感 */
  font-weight: 600;
  margin-bottom: 20px;
  color: var(--ink-sub);
  text-transform: capitalize; /* 首字母大写，更优雅 */
}

/* ===== 输入区（法式精致输入框，贴合整体风格） ===== */
.preference-input-container {
  display: flex;
  gap: 14px;
}

input[type="text"] {
  flex: 1;
  padding: 14px 20px;
  border-radius: var(--radius-sm);
  border: 1px solid var(--bg-soft);
  background: #FFF;
  font-size: 1.05rem;
  transition: var(--transition);
  box-shadow: var(--shadow-soft);
  color: var(--ink-main);
}

input[type="text"]:focus {
  outline: none;
  border-color: var(--accent-warm);
  box-shadow: 0 0 0 3px rgba(166, 124, 82, 0.15);
  transform: translateY(-1px);
}

/* ===== 添加按钮（法式简约，对应配色，hover反馈） ===== */
.btn-love,
.btn-hate {
  padding: 12px 26px;
  border-radius: var(--radius-sm);
  border: none;
  cursor: pointer;
  font-size: 1.0rem;
  transition: var(--transition);
  box-shadow: var(--shadow-soft);
  letter-spacing: 1px;
}

.btn-love {
  background: var(--love-border);
  color: white;
}

.btn-hate {
  background: var(--hate-border);
  color: white;
}

.btn-love:hover {
  background: var(--love-hover);
  color: var(--love-border);
  transform: translateY(-2px);
  box-shadow: var(--shadow-hover);
}

.btn-hate:hover {
  background: var(--hate-hover);
  color: var(--hate-border);
  transform: translateY(-2px);
  box-shadow: var(--shadow-hover);
}

/* ===== 贴纸（法式餐牌风格，精致卡片，拖拽反馈） ===== */
.preference-sticker {
  background: var(--love-bg);
  border: 1px solid var(--love-border);
  border-radius: var(--radius-sm);
  padding: 14px 18px;
  margin-bottom: 16px;
  font-size: 1.05rem;
  cursor: grab;
  box-shadow: 0 4px 12px rgba(0, 0, 0, 0.05);
  transition: var(--transition);
  letter-spacing: 0.5px;
}

/* 不爱吃贴纸样式 */
.preference-sticker.hate {
  background: var(--hate-bg);
  border-color: var(--hate-border);
}

/* 共同偏好贴纸样式 */
.preference-sticker.common {
  background: var(--common-bg);
  border-color: var(--common-border);
  cursor: default;
}

/* 拖拽激活状态（法式轻微缩放+旋转，增加灵动感） */
.preference-sticker:active {
  cursor: grabbing;
  transform: scale(1.03) rotate(-1deg);
  box-shadow: var(--shadow-hover);
}

/* 占位符样式（贴合对应区域配色） */
.placeholder {
  height: 52px;
  margin-bottom: 16px;
  border-radius: var(--radius-sm);
  border: 1px dashed var(--love-border);
  background: rgba(154, 179, 201, 0.1);
}

.placeholder.hate-placeholder {
  border-color: var(--hate-border);
  background: rgba(201, 138, 138, 0.1);
}

/* ===== 垃圾桶（法式精致圆形，不突兀，hover反馈） ===== */
.trash-bin {
  position: fixed;
  bottom: 40px;
  left: 50%;
  transform: translateX(-50%);
  width: 88px;
  height: 88px;
  border-radius: 50%;
  background: var(--hate-border);
  color: white;
  font-size: 2.2rem;
  display: flex;
  align-items: center;
  justify-content: center;
  opacity: 0.85;
  transition: var(--transition);
  box-shadow: var(--shadow-soft);
}

.trash-bin.active {
  opacity: 1;
  transform: translateX(-50%) scale(1.08);
  background: #C96A6A;
  box-shadow: var(--shadow-hover);
}

/* ===== 响应式适配（保留功能，优化法式布局） ===== */
@media (max-width: 1200px) {
  .preference-container {
    grid-template-columns: 1fr;
  }

  h1 {
    font-size: 2.4rem;
  }
}

@media (max-width: 768px) {
  body {
    padding: 32px 16px 100px;
  }

  h1 {
    font-size: 2rem;
    margin-bottom: 32px;
  }

  .person-panel,
  .common-panel {
    padding: 24px 20px 28px;
  }

  .trash-bin {
    width: 76px;
    height: 76px;
    font-size: 1.8rem;
  }
}
</style>

    <!-- 引入 Font Awesome 用于垃圾桶图标 -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
</head>
<body>
    <h1>千代 & 小德 饮食偏好记录</h1>

    <!-- 云端保存/读取按钮 -->
    <div class="cloud-buttons">
        <button onclick="saveToCloud()">保存偏好到云端</button>
        <button onclick="loadFromCloud()">从云端读取偏好</button>
    </div>

    <!-- 饮食偏好主容器（三栏布局） -->
    <div class="preference-container">
        <!-- 左侧：千代的偏好面板 -->
        <div class="person-panel">
            <h2 class="person-title">千代</h2>
            <div class="preference-sections">
                <!-- 千代：爱吃的 -->
                <div class="preference-section" id="chiyo-love" data-type="love" data-person="chiyo">
                    <h3 class="section-title-person section-title-love">爱吃的</h3>
                </div>
                <!-- 千代：输入框（爱吃） -->
                <div class="preference-input-container">
                    <input type="text" id="chiyo-love-input" placeholder="输入千代爱吃的食物...">
                    <button class="btn-love" onclick="addPreference('chiyo', 'love')">添加</button>
                </div>

                <!-- 千代：不爱吃的 -->
                <div class="preference-section" id="chiyo-hate" data-type="hate" data-person="chiyo">
                    <h3 class="section-title-person section-title-hate">不爱吃的</h3>
                </div>
                <!-- 千代：输入框（不爱吃） -->
                <div class="preference-input-container">
                    <input type="text" id="chiyo-hate-input" placeholder="输入千代不爱吃的食物...">
                    <button class="btn-hate" onclick="addPreference('chiyo', 'hate')">添加</button>
                </div>
            </div>
        </div>

        <!-- 中间：共同偏好面板（自动汇总，不可输入） -->
        <div class="common-panel">
            <h2 class="common-title">二人共同偏好</h2>
            <div class="preference-sections">
                <!-- 共同：都爱吃的 -->
                <div class="preference-section" id="common-love" data-type="common-love">
                    <h3 class="section-title-common">都爱吃的</h3>
                </div>

                <!-- 共同：都不爱吃的 -->
                <div class="preference-section" id="common-hate" data-type="common-hate">
                    <h3 class="section-title-common">都不爱吃的</h3>
                </div>
            </div>
        </div>

        <!-- 右侧：小德的偏好面板 -->
        <div class="person-panel">
            <h2 class="person-title">小德</h2>
            <div class="preference-sections">
                <!-- 小德：爱吃的 -->
                <div class="preference-section" id="xiaode-love" data-type="love" data-person="xiaode">
                    <h3 class="section-title-person section-title-love">爱吃的</h3>
                </div>
                <!-- 小德：输入框（爱吃） -->
                <div class="preference-input-container">
                    <input type="text" id="xiaode-love-input" placeholder="输入小德爱吃的食物...">
                    <button class="btn-love" onclick="addPreference('xiaode', 'love')">添加</button>
                </div>

                <!-- 小德：不爱吃的 -->
                <div class="preference-section" id="xiaode-hate" data-type="hate" data-person="xiaode">
                    <h3 class="section-title-person section-title-hate">不爱吃的</h3>
                </div>
                <!-- 小德：输入框（不爱吃） -->
                <div class="preference-input-container">
                    <input type="text" id="xiaode-hate-input" placeholder="输入小德不爱吃的食物...">
                    <button class="btn-hate" onclick="addPreference('xiaode', 'hate')">添加</button>
                </div>
            </div>
        </div>
    </div>

    <!-- 垃圾桶 -->
    <div class="trash-bin" id="trash-bin">
        <i class="fas fa-trash"></i>
    </div>

    <!-- Firebase 配置与核心逻辑 -->
    <script type="module">
        // 导入 Firebase
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import {
            getFirestore,
            collection,
            writeBatch,
            getDocs,
            doc
        } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

        // Firebase 配置（沿用原有项目配置）
        const firebaseConfig = {
            apiKey: "AIzaSyAhZtgaE8mL3GkxsIj17g1ha-Y5HG02C_A",
            authDomain: "weight-zqy.firebaseapp.com",
            projectId: "weight-zqy",
            storageBucket: "weight-zqy.firebasestorage.app",
            messagingSenderId: "710580530798",
            appId: "1:710580530798:web:30e48f089452364c02c07f"
        };

        // 初始化 Firebase
        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);
        const PREFERENCE_KEY = "food_preference_v1"; // 本地存储键

        // 初始化本地数据结构
        let preferenceData = JSON.parse(localStorage.getItem(PREFERENCE_KEY) || JSON.stringify({
            chiyo: { love: [], hate: [] },
            xiaode: { love: [], hate: [] }
        }));

        // 全局拖拽相关变量
        let draggingSticker = null;
        let placeholder = null;
        let currentSection = null;

        // ========== 本地数据操作 ==========
        // 保存到本地 localStorage
        function saveToLocal() {
            localStorage.setItem(PREFERENCE_KEY, JSON.stringify(preferenceData));
        }

        // 计算共同偏好（核心：找出二人相同的食物）
        function calculateCommonPreferences() {
            // 共同爱吃：千代爱吃 ∩ 小德爱吃
            const commonLove = preferenceData.chiyo.love
                .map(item => item.content)
                .filter(content => preferenceData.xiaode.love.some(item => item.content === content));

            // 共同不爱吃：千代不爱吃 ∩ 小德不爱吃
            const commonHate = preferenceData.chiyo.hate
                .map(item => item.content)
                .filter(content => preferenceData.xiaode.hate.some(item => item.content === content));

            return { commonLove, commonHate };
        }

        // 渲染所有内容（个人偏好 + 共同偏好）
        function renderAll() {
            // 1. 清空所有面板内容
            clearAllSections();

            // 2. 渲染个人偏好（千代 + 小德）
            renderPersonPreferences("chiyo");
            renderPersonPreferences("xiaode");

            // 3. 计算并渲染共同偏好
            renderCommonPreferences();
        }

        // 清空所有区域内容
        function clearAllSections() {
            // 个人区域
            document.getElementById("chiyo-love").innerHTML = '<h3 class="section-title-person section-title-love">爱吃的</h3>';
            document.getElementById("chiyo-hate").innerHTML = '<h3 class="section-title-person section-title-hate">不爱吃的</h3>';
            document.getElementById("xiaode-love").innerHTML = '<h3 class="section-title-person section-title-love">爱吃的</h3>';
            document.getElementById("xiaode-hate").innerHTML = '<h3 class="section-title-person section-title-hate">不爱吃的</h3>';

            // 共同区域
            document.getElementById("common-love").innerHTML = '<h3 class="section-title-common">都爱吃的</h3>';
            document.getElementById("common-hate").innerHTML = '<h3 class="section-title-common">都不爱吃的</h3>';
        }

        // 渲染个人偏好
        function renderPersonPreferences(person) {
            // 渲染爱吃的
            preferenceData[person].love.forEach((item, index) => {
                const sticker = createPreferenceSticker(person, "love", index, item);
                document.getElementById(`${person}-love`).appendChild(sticker);
            });

            // 渲染不爱吃的
            preferenceData[person].hate.forEach((item, index) => {
                const sticker = createPreferenceSticker(person, "hate", index, item);
                document.getElementById(`${person}-hate`).appendChild(sticker);
            });
        }

        // 渲染共同偏好
        function renderCommonPreferences() {
            const { commonLove, commonHate } = calculateCommonPreferences();

            // 渲染共同爱吃的
            commonLove.forEach(content => {
                const sticker = createCommonSticker(content, "love");
                document.getElementById("common-love").appendChild(sticker);
            });

            // 渲染共同不爱吃的
            commonHate.forEach(content => {
                const sticker = createCommonSticker(content, "hate");
                document.getElementById("common-hate").appendChild(sticker);
            });
        }

        // 创建个人偏好贴纸
        function createPreferenceSticker(person, type, index, item) {
            const sticker = document.createElement("div");
            // 根据类型设置对应样式类（核心：确保初始颜色正确）
            sticker.className = `preference-sticker ${type === 'hate' ? 'hate' : ''}`;
            sticker.dataset.person = person;
            sticker.dataset.type = type;
            sticker.dataset.index = index;
            sticker.innerText = item.content;

            // 绑定拖拽事件
            sticker.addEventListener("mousedown", startDrag);
            sticker.addEventListener("touchstart", startDrag, { passive: true });

            return sticker;
        }

        // 创建共同偏好贴纸（不可拖拽）
        function createCommonSticker(content, type) {
            const sticker = document.createElement("div");
            sticker.className = `preference-sticker common ${type === 'hate' ? 'hate' : ''}`;
            sticker.innerText = content;
            return sticker;
        }

        // 添加新偏好
        function addPreference(person, type) {
            const input = document.getElementById(`${person}-${type}-input`);
            const content = input.value.trim();
            if (!content) return;

            // 避免重复添加（个人内部去重）
            const isDuplicate = preferenceData[person][type].some(item => item.content === content);
            if (isDuplicate) {
                alert(`已经添加过「${content}」啦～`);
                input.value = "";
                return;
            }

            // 添加到本地数据
            preferenceData[person][type].push({
                content: content,
                createTime: Date.now()
            });

            // 保存并重新渲染
            saveToLocal();
            renderAll();

            // 清空输入框
            input.value = "";
        }

        // 删除偏好
        function deletePreference(person, type, index) {
            preferenceData[person][type].splice(index, 1);
            saveToLocal();
            renderAll();
        }

        // ========== 拖拽功能实现（核心修复：贴纸转移后更新颜色和数据） ==========
        // 开始拖拽
        function startDrag(e) {
            draggingSticker = this;
            currentSection = draggingSticker.parentElement;

            // 跳过共同偏好贴纸（不可拖拽）
            if (draggingSticker.classList.contains("common")) return;

            // 创建占位符（根据当前区域类型设置对应样式）
            placeholder = document.createElement("div");
            placeholder.className = `placeholder ${currentSection.dataset.type === 'hate' ? 'hate-placeholder' : ''}`;
            draggingSticker.parentNode.insertBefore(placeholder, draggingSticker);

            // 隐藏原贴纸（通过透明度，保持布局）
            draggingSticker.style.opacity = "0.6";

            // 绑定移动和结束事件
            document.addEventListener("mousemove", dragMove);
            document.addEventListener("mouseup", endDrag);
            document.addEventListener("touchmove", dragMove, { passive: true });
            document.addEventListener("touchend", endDrag);
        }

        // 拖拽移动
        function dragMove(e) {
            if (!draggingSticker || draggingSticker.classList.contains("common")) return;

            // 兼容鼠标和触摸事件
            let clientX = e.clientX || (e.touches && e.touches[0].clientX);
            let clientY = e.clientY || (e.touches && e.touches[0].clientY);

            // 设置贴纸跟随鼠标/触摸点
            draggingSticker.style.position = "absolute";
            draggingSticker.style.left = `${clientX - draggingSticker.offsetWidth / 2}px`;
            draggingSticker.style.top = `${clientY - draggingSticker.offsetHeight / 2}px`;

            // 检测是否进入垃圾桶
            const trashBin = document.getElementById("trash-bin");
            const trashRect = trashBin.getBoundingClientRect();
            const isOverTrash = clientX >= trashRect.left && clientX <= trashRect.right &&
                                clientY >= trashRect.top && clientY <= trashRect.bottom;

            // 切换垃圾桶激活状态
            if (isOverTrash) {
                trashBin.classList.add("active");
            } else {
                trashBin.classList.remove("active");
            }

            // 检测是否进入个人偏好区域（仅允许在个人区域拖拽，更新当前区域）
            const personSections = document.querySelectorAll(".preference-section[data-person]");
            personSections.forEach(section => {
                const rect = section.getBoundingClientRect();
                if (clientX >= rect.left && clientX <= rect.right && clientY >= rect.top && clientY <= rect.bottom) {
                    if (section !== currentSection) {
                        currentSection = section;
                        // 更新占位符样式为目标区域类型（核心：占位符颜色对应目标区域）
                        placeholder.className = `placeholder ${currentSection.dataset.type === 'hate' ? 'hate-placeholder' : ''}`;
                        section.appendChild(placeholder);
                    }
                }
            });
        }

        // 结束拖拽（核心修复：更新贴纸颜色、数据类型并同步本地存储）
        function endDrag(e) {
            if (!draggingSticker || draggingSticker.classList.contains("common")) return;

            // 恢复贴纸基础样式
            draggingSticker.style.opacity = "1";
            draggingSticker.style.position = "";
            draggingSticker.style.left = "";
            draggingSticker.style.top = "";

            // 提取拖拽相关数据
            const originalPerson = draggingSticker.dataset.person;
            const originalType = draggingSticker.dataset.type;
            const originalIndex = parseInt(draggingSticker.dataset.index);
            const stickerContent = draggingSticker.innerText;

            // 检测是否删除（放入垃圾桶）
            const trashBin = document.getElementById("trash-bin");
            const trashRect = trashBin.getBoundingClientRect();
            let clientX = e.clientX || (e.changedTouches && e.changedTouches[0].clientX);
            let clientY = e.clientY || (e.changedTouches && e.changedTouches[0].clientY);
            const isOverTrash = clientX >= trashRect.left && clientX <= trashRect.right &&
                                clientY >= trashRect.top && clientY <= trashRect.bottom;

            if (isOverTrash) {
                // 删除偏好
                deletePreference(originalPerson, originalType, originalIndex);
            } else if (currentSection && placeholder) {
                // 目标区域数据提取
                const targetPerson = currentSection.dataset.person;
                const targetType = currentSection.dataset.type;

                // 1. 仅当「区域类型变化」或「人员变化」时，执行数据迁移和样式更新
                if (originalPerson !== targetPerson || originalType !== targetType) {
                    // a. 从原数据中删除该偏好
                    preferenceData[originalPerson][originalType].splice(originalIndex, 1);

                    // b. 避免在目标区域重复添加
                    const isDuplicate = preferenceData[targetPerson][targetType].some(item => item.content === stickerContent);
                    if (!isDuplicate) {
                        // c. 添加到目标区域数据中
                        preferenceData[targetPerson][targetType].push({
                            content: stickerContent,
                            createTime: Date.now()
                        });
                    }

                    // d. 保存本地数据并重新渲染（核心：确保数据与视图同步）
                    saveToLocal();
                    renderAll();
                } else {
                    // 2. 区域无变化，仅恢复布局
                    currentSection.replaceChild(draggingSticker, placeholder);
                }
            }

            // 清空拖拽变量
            draggingSticker = null;
            placeholder = null;
            currentSection = null;
            trashBin.classList.remove("active");

            // 解绑事件
            document.removeEventListener("mousemove", dragMove);
            document.removeEventListener("mouseup", endDrag);
            document.removeEventListener("touchmove", dragMove);
            document.removeEventListener("touchend", endDrag);
        }

        // ========== 云端数据同步 ==========
        // 保存到 Firebase 云端
        async function saveToCloudImpl() {
            try {
                const preferencesRef = collection(db, "food_preferences");

                // 步骤1：删除云端旧数据
                const oldSnap = await getDocs(preferencesRef);
                const batch = writeBatch(db);
                oldSnap.docs.forEach(docItem => {
                    batch.delete(docItem.ref);
                });
                await batch.commit();

                // 步骤2：批量上传最新偏好数据
                const newBatch = writeBatch(db);
                const docRef = doc(preferencesRef); // 生成唯一文档
                newBatch.set(docRef, {
                    ...preferenceData,
                    updateTime: Date.now()
                });
                await newBatch.commit();

                alert("饮食偏好数据已成功保存到云端！");
            } catch (e) {
                alert(`保存失败：${e.message || JSON.stringify(e)}`);
                console.error("云端保存错误：", e);
            }
        }

        // 从 Firebase 云端读取
        async function loadFromCloudImpl() {
            try {
                const preferencesRef = collection(db, "food_preferences");
                const snap = await getDocs(preferencesRef);

                if (snap.empty) {
                    alert("云端暂无饮食偏好数据！");
                    return;
                }

                // 提取最新数据
                const cloudData = snap.docs[0].data();
                preferenceData.chiyo = cloudData.chiyo || { love: [], hate: [] };
                preferenceData.xiaode = cloudData.xiaode || { love: [], hate: [] };

                // 保存到本地并渲染
                saveToLocal();
                renderAll();
                alert("饮食偏好数据已从云端成功读取！");
            } catch (e) {
                alert(`读取失败：${e.message || JSON.stringify(e)}`);
                console.error("云端读取错误：", e);
            }
        }

        // ========== 全局函数挂载（解决模块作用域问题） ==========
        window.addPreference = addPreference;
        window.saveToCloud = saveToCloudImpl;
        window.loadFromCloud = loadFromCloudImpl;

        // ========== 页面初始化 ==========
        renderAll();
    </script>
</body>
</html>
