<!DOCTYPE html>
<html lang="zh">
<head>
<meta charset="UTF-8">
<title>å‡è‚¥ç§¯åˆ†ç³»ç»Ÿ</title>
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

<style>
:root{
  --bg-main:#f4f6fb;
  --bg-grad1:#eef2ff;
  --bg-grad2:#f7f4ff;
  --card-bg:rgba(255,255,255,.75);
  --border:rgba(30,30,60,.08);

  --text-main:#1c1f2a;
  --text-sub:#5a5f73;
  --accent:#6b7cff;

  --plus:#e6f6ee;
  --minus:#fde8ec;
  --weekend:#fff6dc;
}

*{
  box-sizing:border-box;
  font-family:-apple-system,BlinkMacSystemFont,
  "Segoe UI","PingFang SC","Microsoft YaHei",sans-serif;
}

body{
  margin:0;
  padding:40px 24px 80px;
  background:
    linear-gradient(120deg,var(--bg-grad1),var(--bg-grad2),var(--bg-main));
  color:var(--text-main);
}

/* ===== é¡µé¢æ ‡é¢˜ ===== */
h1{
  font-size:40px;
  letter-spacing:-.02em;
  margin-bottom:32px;
}

h2{
  font-size:20px;
  margin-bottom:16px;
}

/* ===== å¡ç‰‡åŒºå— ===== */
.section{
  background:var(--card-bg);
  border:1px solid var(--border);
  border-radius:18px;
  padding:24px;
  margin-bottom:28px;
  backdrop-filter:blur(14px);
}

/* ===== è¡¨æ ¼ ===== */
table{
  width:100%;
  border-collapse:collapse;
  font-size:14px;
}

th,td{
  padding:8px 6px;
  text-align:center;
}

th{
  color:var(--text-sub);
  font-weight:500;
  border-bottom:1px solid var(--border);
}

td{
  border-bottom:1px solid rgba(0,0,0,.04);
}

tr:last-child td{
  border-bottom:none;
}

/* ===== çŠ¶æ€è‰² ===== */
.plus{ background:var(--plus); }
.minus{ background:var(--minus); }
.weekend{ background:var(--weekend); }

/* ===== è¾“å…¥æ§ä»¶ ===== */
input[type="number"]{
  width:64px;
  border:1px solid var(--border);
  border-radius:6px;
  padding:4px;
  background:rgba(255,255,255,.8);
}

input[type="checkbox"]{
  transform:scale(1.1);
  cursor:pointer;
}

/* ===== æŒ‰é’® ===== */
button{
  margin:24px 0;
  padding:10px 18px;
  border:none;
  border-radius:10px;
  background:var(--accent);
  color:#fff;
  font-size:14px;
  cursor:pointer;
}

button:hover{
  opacity:.9;
}

/* ===== å›¾è¡¨ ===== */
canvas{
  max-height:220px;
}

/* ===== è¡¨æ ¼æ•´ä½“å®¹å™¨ ===== */
.table-wrap{
  background:var(--card-bg);
  border:1px solid var(--border);
  border-radius:18px;
  padding:16px;
  backdrop-filter:blur(14px);
  overflow-x:auto;
}
</style>
</head>

<body>

<h1>å‡è‚¥ç§¯åˆ†çœ‹æ¿</h1>

<div class="section">
  <h2>ç§¯åˆ†æ’è¡Œæ¦œ</h2>
  <table>
    <thead>
      <tr><th>å§“å</th><th>æœ¬å‘¨</th><th>æ€»è®¡</th></tr>
    </thead>
    <tbody id="rank"></tbody>
  </table>
</div>

<div class="section">
  <h2>ä½“é‡è¶‹åŠ¿</h2>
  <canvas id="chart"></canvas>
</div>

<button onclick="addDay()">ï¼‹ æ–°å¢ä¸€å¤©</button>

<div class="table-wrap">
<table>
<thead>
<tr>
<th>æ—¥æœŸ</th><th>å§“å</th><th>ç­¾åˆ°</th><th>ä½“é‡</th>
<th>å˜åŒ–</th><th>æ—©ç¡</th><th>ç†¬å¤œ</th><th>è¿åŠ¨</th>
<th>é¢å¤–</th><th>å¾—åˆ†</th>
</tr>
</thead>
<tbody id="records"></tbody>
</table>
</div>

<script>
const KEY = "diet_records_v3";
const START_DATE = "2025-11-14";
let data = JSON.parse(localStorage.getItem(KEY) || "[]");
let chart;

function isWeekend(d){
  d=new Date(d); return d.getDay()==0||d.getDay()==6;
}
function weekStart(d){
  d=new Date(d); let day=d.getDay()||7;
  d.setDate(d.getDate()-day+1);
  return d.toISOString().slice(0,10);
}
function lastWeight(name, idx){
  for(let i=idx-1;i>=0;i--){
    if(data[i].name===name && data[i].weight!=="")
      return Number(data[i].weight);
  }
  return null;
}
function score(r){
  let s=0;
  if(r.checkin) s+=1;
  if(r.weight!=="") s+=1;
  if(r.diff===1) s+=2;
  if(r.diff===-1) s-=2;
  if(r.sleepEarly) s+=2;
  if(r.sleepLate) s-=2;
  if(r.exercise) s+=2;
  if(isWeekend(r.date)) s*=2;
  return s + Number(r.extra||0);
}

function addDay(){
  let next;
  if(data.length===0){
    next = new Date(START_DATE);
  }else{
    next = new Date(data[data.length-1].date);
    next.setDate(next.getDate()+1);
  }
  const d = next.toISOString().slice(0,10);
  ["åƒä»£","å°å¾·"].forEach(n=>{
    data.push({
      date:d,name:n,checkin:true,weight:"",
      diff:0,sleepEarly:false,sleepLate:false,
      exercise:false,extra:0
    });
  });
  save();
}

function update(i,k,v){
  data[i][k]=v;
  if(k==="weight"){
    let prev=lastWeight(data[i].name,i);
    if(prev!==null){
      if(Number(v)<prev) data[i].diff=1;
      else if(Number(v)>prev) data[i].diff=-1;
      else data[i].diff=0;
    }
  }
  save();
}

function save(){
  localStorage.setItem(KEY,JSON.stringify(data));
  render();
}

function render(){
  renderTable();
  renderRank();
  renderChart();
}

function renderTable(){
  const tb=document.getElementById("records");
  tb.innerHTML="";
  data.forEach((r,i)=>{
    const tr=document.createElement("tr");
    if(isWeekend(r.date)) tr.classList.add("weekend");
    tr.innerHTML=`
<td>${r.date}</td>
<td>${r.name}</td>
<td class="${r.checkin?'plus':''}">
<input type="checkbox" ${r.checkin?'checked':''}
 onchange="update(${i},'checkin',this.checked)">
</td>
<td><input type="number" value="${r.weight}"
 onchange="update(${i},'weight',this.value)"></td>
<td class="${r.diff===1?'plus':r.diff===-1?'minus':''}">
${r.diff===1?'â†“':r.diff===-1?'â†‘':''}
</td>
<td class="${r.sleepEarly?'plus':''}">
<input type="checkbox" ${r.sleepEarly?'checked':''}
 onchange="update(${i},'sleepEarly',this.checked)">
</td>
<td class="${r.sleepLate?'minus':''}">
<input type="checkbox" ${r.sleepLate?'checked':''}
 onchange="update(${i},'sleepLate',this.checked)">
</td>
<td class="${r.exercise?'plus':''}">
<input type="checkbox" ${r.exercise?'checked':''}
 onchange="update(${i},'exercise',this.checked)">
</td>
<td><input type="number" value="${r.extra}"
 onchange="update(${i},'extra',this.value)"></td>
<td>${score(r)}</td>`;
    tb.appendChild(tr);
  });
}

function renderRank(){
  const ws=weekStart(new Date());
  const sum={};
  data.forEach(r=>{
    if(!sum[r.name]) sum[r.name]={w:0,t:0};
    const s=score(r);
    sum[r.name].t+=s;
    if(r.date>=ws) sum[r.name].w+=s;
  });
  const tb=document.getElementById("rank");
  tb.innerHTML="";
  Object.entries(sum).forEach(([n,v])=>{
    tb.innerHTML+=`<tr><td>${n}</td><td>${v.w}</td><td>${v.t}</td></tr>`;
  });
}

function renderChart(){
  const labels=[...new Set(data.map(r=>r.date))];
  const ds={};
  data.forEach(r=>{
    if(r.weight==="") return;
    if(!ds[r.name]) ds[r.name]={};
    ds[r.name][r.date]=Number(r.weight);
  });

  const datasets=Object.entries(ds).map(([name,map])=>({
    label:name,
    data:labels.map(d=>map[d]??null),
    spanGaps:true,
    borderWidth:2
  }));

  if(chart) chart.destroy();
  chart=new Chart(document.getElementById("chart"),{
    type:"line",
    data:{labels,datasets},
    options:{
      responsive:true,
      plugins:{legend:{position:"top"}},
      scales:{y:{title:{display:true,text:"ä½“é‡"}}}
    }
  });
}

render();
</script>
  
<script type="module">
  import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
  import { getFirestore, collection, addDoc }
    from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

  const firebaseConfig = {
    apiKey: "AIzaSyAhZtgaE8mL3GkxsIj17g1ha-Y5HG02C_A",
    authDomain: "weight-zqy.firebaseapp.com",
    projectId: "weight-zqy",
    storageBucket: "weight-zqy.firebasestorage.app",
    messagingSenderId: "710580530798",
    appId: "1:710580530798:web:30e48f089452364c02c07f"
  };

  const app = initializeApp(firebaseConfig);
  const db = getFirestore(app);

  // âš ï¸ å…³é”®ï¼šæ˜ç¡®æŒ‚åˆ° window
  window.saveToCloud = async function () {
    console.log("å¼€å§‹ä¿å­˜åˆ°äº‘ç«¯");
import { getDocs, collection, query, orderBy } 
  from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

/* ===== ä»äº‘ç«¯æ¢å¤æ•°æ® ===== */
window.loadFromCloud = async function () {
  try {
    const q = query(
      collection(db, "records"),
      orderBy("createdAt", "asc")
    );

    const snap = await getDocs(q);

    if (snap.empty) {
      console.log("äº‘ç«¯æ²¡æœ‰æ•°æ®");
      return;
    }

    const data = snap.docs.map(d => d.data());

    // è½¬æ¢æˆä½ æœ¬åœ° data çš„ç»“æ„
    const normalized = data.map(r => ({
      date: r.date,
      name: r.name,
      checkin: r.checkin,
      weight: r.weight ?? "",
      diff: r.diff,
      sleepEarly: r.sleepEarly,
      sleepLate: r.sleepLate,
      exercise: r.exercise,
      extra: r.extra ?? 0
    }));

    localStorage.setItem(
      "diet_records_v3",
      JSON.stringify(normalized)
    );

    console.log("å·²ä»äº‘ç«¯æ¢å¤", normalized.length, "æ¡è®°å½•");

    // ğŸ”´ æ ¸å¿ƒï¼šé€šçŸ¥æœ¬åœ°è„šæœ¬é‡æ–°æ¸²æŸ“
    location.reload();

  } catch (e) {
    console.error("äº‘ç«¯æ¢å¤å¤±è´¥", e);
    alert("äº‘ç«¯æ¢å¤å¤±è´¥ï¼ŒæŸ¥çœ‹æ§åˆ¶å°");
  }
};

    try {
      const raw = localStorage.getItem("diet_records_v3");
      if (!raw) {
        alert("æœ¬åœ°æ²¡æœ‰ä»»ä½•æ•°æ®");
        return;
      }

      const data = JSON.parse(raw);
      if (!data.length) {
        alert("æ•°æ®ä¸ºç©º");
        return;
      }

      let count = 0;

      for (const r of data) {
        await addDoc(collection(db, "records"), {
          date: r.date,
          name: r.name,
          weight: r.weight === "" ? null : Number(r.weight),
          diff: r.diff,
          checkin: r.checkin,
          sleepEarly: r.sleepEarly,
          sleepLate: r.sleepLate,
          exercise: r.exercise,
          extra: Number(r.extra || 0),
          score: null,
          createdAt: Date.now()
        });
        count++;
      }

      alert(`æˆåŠŸä¿å­˜ ${count} æ¡çœŸå®è®°å½•åˆ°äº‘ç«¯`);
    } catch (e) {
      console.error("ä¿å­˜å¤±è´¥ï¼š", e);
      alert("ä¿å­˜å¤±è´¥ï¼Œè¯·æ‰“å¼€æ§åˆ¶å°æŸ¥çœ‹é”™è¯¯");
    }
  };
</script>


<button onclick="saveToCloud()">ä¿å­˜ä¿®æ”¹</button>
<button onclick="loadFromCloud()">ä»äº‘ç«¯æ¢å¤</button>


  
</body>
</html>
