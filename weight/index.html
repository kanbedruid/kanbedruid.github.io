<!DOCTYPE html>
<html lang="zh">
<head>
<meta charset="UTF-8">
<title>减肥积分系统</title>
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

<style>
:root{
  --plus:#e6f6ee;
  --minus:#fde8ec;
  --weekend:#fff6dc;
}
body{font-family:sans-serif;padding:24px;background:#f4f6fb}
.section{background:#fff;padding:16px;border-radius:12px;margin-bottom:24px}
table{width:100%;border-collapse:collapse;font-size:14px}
th,td{border-bottom:1px solid #ddd;padding:6px;text-align:center}
.plus{background:var(--plus)}
.minus{background:var(--minus)}
.weekend{background:var(--weekend)}
button{padding:8px 14px;border:none;border-radius:6px;background:#6b7cff;color:#fff;cursor:pointer}
canvas{max-height:200px}
</style>
</head>

<body>

<h1>减肥积分看板</h1>

<div class="section">
  <h2>积分排行榜</h2>
  <table>
    <thead><tr><th>姓名</th><th>本周</th><th>总计</th></tr></thead>
    <tbody id="rank"></tbody>
  </table>
</div>

<div class="section">
  <h2>体重趋势</h2>
  <canvas id="chart"></canvas>
</div>

<button onclick="addDay()">＋ 新增一天</button>
<button onclick="saveToCloud()">保存到云端</button>

<div class="section">
<table>
<thead>
<tr>
<th>日期</th><th>姓名</th><th>签到</th><th>体重</th>
<th>变化</th><th>早睡</th><th>熬夜</th><th>运动</th>
<th>额外</th><th>得分</th>
</tr>
</thead>
<tbody id="records"></tbody>
</table>
</div>

<script>
const START_DATE="2025-11-14";
let data=[];
let chart;

function isWeekend(d){d=new Date(d);return d.getDay()==0||d.getDay()==6}
function weekStart(d){d=new Date(d);let day=d.getDay()||7;d.setDate(d.getDate()-day+1);return d.toISOString().slice(0,10)}
function lastWeight(name,idx){for(let i=idx-1;i>=0;i--)if(data[i].name===name&&data[i].weight!=="")return Number(data[i].weight);return null}

function score(r){
  let s=0;
  if(r.checkin)s++;
  if(r.weight!=="")s++;
  if(r.diff===1)s+=2;
  if(r.diff===-1)s-=2;
  if(r.sleepEarly)s+=2;
  if(r.sleepLate)s-=2;
  if(r.exercise)s+=2;
  if(isWeekend(r.date))s*=2;
  return s+Number(r.extra||0);
}

function addDay(){
  let next=data.length?new Date(data[data.length-1].date):new Date(START_DATE);
  if(data.length)next.setDate(next.getDate()+1);
  const d=next.toISOString().slice(0,10);
  ["千代","小德"].forEach(n=>data.push({
    date:d,name:n,checkin:true,weight:"",
    diff:0,sleepEarly:false,sleepLate:false,exercise:false,extra:0
  }));
  render();
}

function update(i,k,v){
  data[i][k]=v;
  if(k==="weight"){
    const p=lastWeight(data[i].name,i);
    if(p!==null)data[i].diff=Number(v)<p?1:Number(v)>p?-1:0;
  }
  render();
}

function render(){
  renderTable();renderRank();renderChart();
}

function renderTable(){
  const tb=document.getElementById("records");tb.innerHTML="";
  data.forEach((r,i)=>{
    const tr=document.createElement("tr");
    if(isWeekend(r.date))tr.classList.add("weekend");
    tr.innerHTML=`
<td>${r.date}</td><td>${r.name}</td>
<td class="${r.checkin?'plus':''}"><input type=checkbox ${r.checkin?'checked':''} onchange="update(${i},'checkin',this.checked)"></td>
<td><input type=number value="${r.weight}" onchange="update(${i},'weight',this.value)"></td>
<td class="${r.diff===1?'plus':r.diff===-1?'minus':''}">${r.diff===1?'↓':r.diff===-1?'↑':''}</td>
<td class="${r.sleepEarly?'plus':''}"><input type=checkbox ${r.sleepEarly?'checked':''} onchange="update(${i},'sleepEarly',this.checked)"></td>
<td class="${r.sleepLate?'minus':''}"><input type=checkbox ${r.sleepLate?'checked':''} onchange="update(${i},'sleepLate',this.checked)"></td>
<td class="${r.exercise?'plus':''}"><input type=checkbox ${r.exercise?'checked':''} onchange="update(${i},'exercise',this.checked)"></td>
<td><input type=number value="${r.extra}" onchange="update(${i},'extra',this.value)"></td>
<td>${score(r)}</td>`;
    tb.appendChild(tr);
  });
}

function renderRank(){
  const ws=weekStart(new Date()),sum={};
  data.forEach(r=>{
    sum[r.name]=sum[r.name]||{w:0,t:0};
    const s=score(r);sum[r.name].t+=s;
    if(r.date>=ws)sum[r.name].w+=s;
  });
  const tb=document.getElementById("rank");tb.innerHTML="";
  Object.entries(sum).forEach(([n,v])=>tb.innerHTML+=`<tr><td>${n}</td><td>${v.w}</td><td>${v.t}</td></tr>`);
}

function renderChart(){
  const labels=[...new Set(data.map(r=>r.date))];
  const ds={};
  data.forEach(r=>{if(r.weight==="")return;ds[r.name]=ds[r.name]||{};ds[r.name][r.date]=Number(r.weight)});
  const sets=Object.entries(ds).map(([n,m])=>({label:n,data:labels.map(d=>m[d]??null),spanGaps:true}));
  if(chart)chart.destroy();
  chart=new Chart(document.getElementById("chart"),{type:"line",data:{labels,datasets:sets}});
}
</script>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
import { getFirestore, collection, getDocs, doc, setDoc } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

const app=initializeApp({
  apiKey:"AIzaSyAhZtgaE8mL3GkxsIj17g1ha-Y5HG02C_A",
  authDomain:"weight-zqy.firebaseapp.com",
  projectId:"weight-zqy"
});
const db=getFirestore(app);

window.saveToCloud=async()=>{
  for(const r of data){
    await setDoc(doc(db,"records",`${r.date}_${r.name}`),r,{merge:true});
  }
  alert("已同步到云端");
};

(async()=>{
  const snap=await getDocs(collection(db,"records"));
  data=snap.docs.map(d=>d.data()).sort((a,b)=>a.date.localeCompare(b.date));
  render();
})();
</script>

</body>
</html>


