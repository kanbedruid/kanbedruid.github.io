<!DOCTYPE html>
<html lang="zh">
<head>
<meta charset="UTF-8">
<title>健康记录</title>
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

<style>
:root{
  /* ===== 高饱和度对比配色（满足要求：对比度高、无相近色） ===== */
  --bg-main:#f8f9fc;
  --bg-grad1:#eef5ff;
  --bg-grad2:#fff5f8;
  --card-bg:rgba(255,255,255,0.9);
  --border:#dce1e9;

  --text-main:#1a1c24;
  --text-sub:#4e5969;
  --accent:#2563eb; /* 高饱和蓝（主强调色） */

  /* 高饱和度功能色（区分明显，无重合，对比度高） */
  --plus:#059669; /* 深翠绿（正向：签到、早睡、运动） */
  --plus-bg:#d1fae5; /* 翠绿浅背景（与plus形成高对比，不刺眼） */
  --minus:#dc2626; /* 正红（负向：熬夜、体重上升） */
  --minus-bg:#fee2e2; /* 红浅背景（与minus高对比） */
  --weekend:#f59e0b; /* 亮橙黄（周末） */
  --weekend-bg:#fffbeb; /* 橙黄浅背景（与weekend高对比） */
  
  /* 表格单元格间距（解决色块重合核心：增加单元格边框间距） */
  --cell-gap: 4px; /* 单元格之间的空隙，避免色块相连 */

  --radius-lg: 18px;
  --radius-md: 12px;
  --radius-sm: 8px;
  --shadow-soft: 0 4px 16px rgba(0, 0, 0, 0.06);
  --transition: all .3s ease-in-out;
}

*{
  box-sizing:border-box;
  font-family:"Garamond", "Noto Serif SC", serif; /* 法式衬线字体 */
}

body{
  margin:0;
  padding:40px 24px 80px;
  background:
    linear-gradient(120deg,var(--bg-grad1),var(--bg-grad2),var(--bg-main));
  color:var(--text-main);
  max-width: 1500px;
  margin: 0 auto;
}

/* ===== 页面标题（法式风格） ===== */
h1{
  font-size: 3.2rem;
  letter-spacing: 4px;
  margin-bottom: 32px;
  color: var(--accent);
  font-weight: 700;
  text-align: center;
}

h2{
  font-size: 1.8rem;
  margin-bottom: 16px;
  color: var(--text-main);
  padding-bottom: 8px;
  border-bottom: 1px solid var(--border);
}

/* ===== 卡片区块（法式精致卡片） ===== */
.section{
  background:var(--card-bg);
  border:1px solid var(--border);
  border-radius:var(--radius-lg);
  padding:24px;
  margin-bottom:28px;
  backdrop-filter:blur(14px);
  box-shadow: var(--shadow-soft);
  transition: var(--transition);
}

.section:hover{
  box-shadow: 0 8px 24px rgba(0, 0, 0, 0.09);
  transform: translateY(-2px);
}

/* ===== 表格（核心修改：解决色块重合，提高饱和度） ===== */
table{
  width:100%;
  border-collapse: separate; /* 关键1：取消合并边框，改为分离模式 */
  border-spacing: var(--cell-gap); /* 关键2：设置单元格间距，避免色块相连 */
  font-size: 14px;
  table-layout: fixed;
}

th,td{
  padding: 12px 8px; /* 增加内边距，提升色块视觉效果 */
  text-align: center;
  border-radius: var(--radius-sm); /* 单元格圆角，法式精致感 */
  border: none; /* 移除原有边框，避免与色块冲突 */
}

th{
  color:var(--text-sub);
  font-weight: 600;
  background: var(--bg-main); /* 表头背景，区分内容区 */
}

/* 关键：色块样式优化（高饱和度，无重合，独立显示） */
.plus{ 
  background: var(--plus-bg) !important; 
  color: var(--plus);
  font-weight: 500;
  box-shadow: 0 2px 4px rgba(5, 150, 105, 0.1); /* 轻微阴影，突出色块 */
}
.minus{ 
  background: var(--minus-bg) !important; 
  color: var(--minus);
  font-weight: 500;
  box-shadow: 0 2px 4px rgba(220, 38, 38, 0.1);
}
.weekend{ 
  background: var(--weekend-bg) !important; 
  color: var(--weekend);
  font-weight: 500;
  box-shadow: 0 2px 4px rgba(245, 158, 11, 0.1);
}

/* 表格行：避免整行背景重合，仅单元格独立上色 */
tr{
  background: transparent; /* 行背景透明，防止色块被覆盖 */
}

/* ===== 输入控件（法式风格优化，高对比度） ===== */
input[type="number"]{
  width: 72px;
  border: 1px solid var(--border);
  border-radius: var(--radius-sm);
  padding: 8px 6px;
  background: #ffffff;
  color: var(--text-main);
  transition: var(--transition);
  text-align: center;
}

input[type="number"]:focus{
  outline: none;
  border-color: var(--accent);
  box-shadow: 0 0 0 3px rgba(37, 99, 235, 0.15);
}

input[type="checkbox"]{
  transform:scale(1.2);
  cursor:pointer;
  accent-color: var(--accent); /* 复选框高饱和度配色，统一风格 */
}

/* ===== 按钮（法式风格，高饱和度对比） ===== */
button{
  margin:24px 10px 24px 0;
  padding: 12px 20px;
  border:none;
  border-radius: var(--radius-sm);
  background: var(--accent);
  color: #ffffff;
  font-size: 14px;
  cursor: pointer;
  transition: var(--transition);
  box-shadow: var(--shadow-soft);
  letter-spacing: 1px;
}

button:hover{
  opacity: 0.95;
  transform: translateY(-2px);
  box-shadow: 0 6px 12px rgba(37, 99, 235, 0.2);
}

/* ===== 图表（高饱和度数据系列，优化视觉） ===== */
canvas{
  max-height:280px;
  padding: 16px;
  background: var(--card-bg);
  border-radius: var(--radius-md);
  border: 1px solid var(--border);
  margin-top: 16px;
}

/* ===== 表格整体容器（法式风格优化） ===== */
.table-wrap{
  background:var(--card-bg);
  border:1px solid var(--border);
  border-radius:var(--radius-lg);
  padding: 24px 16px;
  backdrop-filter:blur(14px);
  overflow-x:auto;
  box-shadow: var(--shadow-soft);
  margin-top: 16px;
}
</style>
</head>

<body>

<h1>健康记录</h1>

<div class="section">
  <h2>积分排行榜</h2>
  <table>
    <thead>
      <tr><th>姓名</th><th>本周</th><th>总计</th></tr>
    </thead>
    <tbody id="rank"></tbody>
  </table>
</div>

<div class="section">
  <h2>体重趋势</h2>
  <canvas id="chart"></canvas>
</div>

<button onclick="addDay()">＋ 新增一天</button>
<button onclick="saveToCloud()">保存到云端</button>
<button onclick="loadFromCloud()">从云端读取</button>

<div class="table-wrap">
<table>
<thead>
<tr>
<th>日期</th><th>姓名</th><th>签到</th><th>体重</th>
<th>变化</th><th>早睡</th><th>熬夜</th><th>运动</th>
<th>额外</th><th>得分</th>
</tr>
</thead>
<tbody id="records"></tbody>
</table>
</div>

<script>
const KEY = "diet_records_v3";
const START_DATE = "2025-11-14";
let data = JSON.parse(localStorage.getItem(KEY) || "[]");
let chart;

function isWeekend(d){
  d=new Date(d); return d.getDay()==0||d.getDay()==6;
}
function weekStart(d){
  d=new Date(d); let day=d.getDay()||7;
  d.setDate(d.getDate()-day+1);
  return d.toISOString().slice(0,10);
}
function lastWeight(name, idx){
  for(let i=idx-1;i>=0;i--){
    if(data[i].name===name && data[i].weight!=="")
      return Number(data[i].weight);
  }
  return null;
}
function score(r){
  let s=0;
  if(r.checkin) s+=1;
  if(r.weight!=="") s+=1;
  if(r.diff===1) s+=2;
  if(r.diff===-1) s-=2;
  if(r.sleepEarly) s+=2;
  if(r.sleepLate) s-=2;
  if(r.exercise) s+=2;
  if(isWeekend(r.date)) s*=2;
  return s + Number(r.extra||0);
}

function addDay(){
  let next;
  if(data.length===0){
    next = new Date(START_DATE);
  }else{
    next = new Date(data[data.length-1].date);
    next.setDate(next.getDate()+1);
  }
  const d = next.toISOString().slice(0,10);
  ["千代","小德"].forEach(n=>{
    data.push({
      date:d,name:n,checkin:true,weight:"",
      diff:0,sleepEarly:false,sleepLate:false,
      exercise:false,extra:0
    });
  });
  save();
}

function update(i,k,v){
  data[i][k]=v;
  if(k==="weight"){
    let prev=lastWeight(data[i].name,i);
    if(prev!==null){
      if(Number(v)<prev) data[i].diff=1;
      else if(Number(v)>prev) data[i].diff=-1;
      else data[i].diff=0;
    }
  }
  save();
}

function save(){
  localStorage.setItem(KEY,JSON.stringify(data));
  render();
}

function render(){
  renderTable();
  renderRank();
  renderChart();
}

function renderTable(){
  const tb = document.getElementById("records");
  tb.innerHTML = "";

  // 关键：生成“倒序索引列表”，但不改变 data 本身
  const indexes = [...data.keys()].reverse();

  indexes.forEach(i => {
    const r = data[i];
    const tr = document.createElement("tr");

    // 周末仅给日期单元格上色（避免整行色块重合，符合要求）
    const dateTdClass = isWeekend(r.date) ? 'weekend' : '';

    tr.innerHTML = `
<td class="${dateTdClass}">${r.date}</td>
<td>${r.name}</td>
<td class="${r.checkin?'plus':''}">
<input type="checkbox" ${r.checkin?'checked':''}
 onchange="update(${i},'checkin',this.checked)">
</td>
<td><input type="number" value="${r.weight}"
 onchange="update(${i},'weight',this.value)"></td>
<td class="${r.diff===1?'plus':r.diff===-1?'minus':''}">
${r.diff===1?'↓':r.diff===-1?'↑':''}
</td>
<td class="${r.sleepEarly?'plus':''}">
<input type="checkbox" ${r.sleepEarly?'checked':''}
 onchange="update(${i},'sleepEarly',this.checked)">
</td>
<td class="${r.sleepLate?'minus':''}">
<input type="checkbox" ${r.sleepLate?'checked':''}
 onchange="update(${i},'sleepLate',this.checked)">
</td>
<td class="${r.exercise?'plus':''}">
<input type="checkbox" ${r.exercise?'checked':''}
 onchange="update(${i},'exercise',this.checked)">
</td>
<td><input type="number" value="${r.extra}"
 onchange="update(${i},'extra',this.value)"></td>
<td>${score(r)}</td>
`;
    tb.appendChild(tr);
  });
}


function renderRank(){
  const ws=weekStart(new Date());
  const sum={};
  data.forEach(r=>{
    if(!sum[r.name]) sum[r.name]={w:0,t:0};
    const s=score(r);
    sum[r.name].t+=s;
    if(r.date>=ws) sum[r.name].w+=s;
  });
  const tb=document.getElementById("rank");
  tb.innerHTML="";
  Object.entries(sum).forEach(([n,v])=>{
    tb.innerHTML+=`<tr><td>${n}</td><td>${v.w}</td><td>${v.t}</td></tr>`;
  });
}

function renderChart(){
  const labels=[...new Set(data.map(r=>r.date))];
  const ds={};
  data.forEach(r=>{
    if(r.weight==="") return;
    if(!ds[r.name]) ds[r.name]={};
    ds[r.name][r.date]=Number(r.weight);
  });

  // 图表数据系列：高饱和度配色，与页面风格统一
  const datasets=Object.entries(ds).map(([name,map], index)=>{
    const colors = [var(--accent), var(--plus), var(--weekend)]; // 高饱和度配色组
    return {
      label:name,
      data:labels.map(d=>map[d]??null),
      spanGaps:true,
      borderWidth:3,
      borderColor: index === 0 ? var(--accent) : (index === 1 ? var(--plus) : var(--weekend)),
      backgroundColor: index === 0 ? 'rgba(37, 99, 235, 0.1)' : (index === 1 ? 'rgba(5, 150, 105, 0.1)' : 'rgba(245, 158, 11, 0.1)'),
      tension: 0.2
    }
  });

  if(chart) chart.destroy();
  chart=new Chart(document.getElementById("chart"),{
    type:"line",
    data:{labels,datasets},
    options:{
      responsive:true,
      plugins:{legend:{position:"top"}},
      scales:{
        y:{
          title:{display:true,text:"体重"},
          grid:{color:var(--border)}
        },
        x:{
          grid:{display:false}
        }
      }
    }
  });
}

// 提前声明全局函数占位，确保 onclick 能找到
window.saveToCloud = function() {};
window.loadFromCloud = function() {};

// 初始渲染
render();
</script>
  
<script type="module">
  import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
  import {
    getFirestore,
    collection,
    getDocs,
    query,
    orderBy,
    writeBatch,
    doc
  } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

  const firebaseConfig = {
    apiKey: "AIzaSyAhZtgaE8mL3GkxsIj17g1ha-Y5HG02C_A",
    authDomain: "weight-zqy.firebaseapp.com",
    projectId: "weight-zqy",
    storageBucket: "weight-zqy.firebasestorage.app",
    messagingSenderId: "710580530798",
    appId: "1:710580530798:web:30e48f089452364c02c07f"
  };

  const app = initializeApp(firebaseConfig);
  const db = getFirestore(app);

  /* ===== 保存到云端（修复重复上传+语法错误） ===== */
  async function saveToCloudImpl() {
    try {
      const raw = localStorage.getItem("diet_records_v3");
      if (!raw) {
        alert("本地没有数据");
        return;
      }

      const localData = JSON.parse(raw);
      if (!localData.length) {
        alert("数据为空");
        return;
      }

      // 步骤1：获取云端旧数据并批量删除（避免重复）
      const recordsRef = collection(db, "records"); // 正确获取集合引用（路径：records）
      const oldQuery = query(recordsRef);
      const oldSnap = await getDocs(oldQuery);
      
      if (!oldSnap.empty) {
        const batch = writeBatch(db);
        oldSnap.docs.forEach(docItem => {
          batch.delete(docItem.ref);
        });
        await batch.commit();
      }

      // 步骤2：批量上传本地最新数据（修复核心：正确生成文档引用）
      const newBatch = writeBatch(db);
      localData.forEach(r => {
        // 正确语法：doc(集合引用) → 生成该集合下的唯一空白文档引用
        const docRef = doc(recordsRef); 
        newBatch.set(docRef, {
          date: r.date,
          name: r.name,
          checkin: r.checkin,
          weight: r.weight === "" ? null : Number(r.weight),
          diff: r.diff,
          sleepEarly: r.sleepEarly,
          sleepLate: r.sleepLate,
          exercise: r.exercise,
          extra: Number(r.extra || 0),
          createdAt: Date.now()
        });
      });

      await newBatch.commit();
      alert(`成功保存 ${localData.length} 条记录到云端（已清除旧数据）`);
      render(); // 刷新页面数据
    } catch (e) {
      alert("保存失败，错误详情：" + (e.message || JSON.stringify(e)));
      console.error("云端保存错误：", e);
    }
  }

  /* ===== 从云端恢复（修复排序+去重问题，优化自动读取） ===== */
  async function loadFromCloudImpl() {
    try {
      const recordsRef = collection(db, "records"); // 正确获取集合引用
      // 修复：按实际记录日期 date 排序
      const q = query(recordsRef, orderBy("date", "asc"));
      const snap = await getDocs(q);

      if (snap.empty) {
        // 自动读取时静默，手动点击时弹窗
        if (document.activeElement?.innerText === "从云端读取") {
          alert("云端没有数据");
        } else {
          console.log("云端暂无健康记录数据，使用本地存储数据");
        }
        return;
      }

      // 步骤1：提取云端数据
      const cloudData = snap.docs.map(d => {
        const r = d.data();
        return {
          date: r.date,
          name: r.name,
          checkin: r.checkin,
          weight: r.weight ?? "",
          diff: r.diff,
          sleepEarly: r.sleepEarly,
          sleepLate: r.sleepLate,
          exercise: r.exercise,
          extra: r.extra ?? 0
        };
      });

      // 步骤2：基于「日期+姓名」去重
      const uniqueMap = new Map();
      cloudData.forEach(item => {
        const uniqueKey = `${item.date}_${item.name}`;
        uniqueMap.set(uniqueKey, item);
      });

      // 步骤3：转换为数组并保持日期排序
      const normalizedData = Array.from(uniqueMap.values()).sort((a, b) => {
        return new Date(a.date) - new Date(b.date);
      });

      // 步骤4：更新本地存储并刷新页面
      localStorage.setItem("diet_records_v3", JSON.stringify(normalizedData));
      
      // 仅手动点击时弹窗，自动读取时静默
      if (document.activeElement?.innerText === "从云端读取") {
        alert(`已从云端恢复 ${normalizedData.length} 条唯一记录`);
      } else {
        console.log(`已从云端自动恢复 ${normalizedData.length} 条健康记录`);
      }
      
      // 刷新数据（无需重载页面，提升体验）
      data = normalizedData;
      save();
      render();
    } catch (e) {
      console.error("云端读取错误：", e);
      // 仅手动点击时弹窗提示错误
      if (document.activeElement?.innerText === "从云端读取") {
        alert("读取失败，错误详情：" + (e.message || JSON.stringify(e)));
      }
    }
  }

  // 关键：将模块内的函数挂载到全局 window 对象，解决 ReferenceError
  window.saveToCloud = saveToCloudImpl;
  window.loadFromCloud = loadFromCloudImpl;

  /* ===== 页面初始化：自动读取云端数据 ===== */
  await loadFromCloudImpl();
</script>

</body>
</html>
