<!DOCTYPE html>
<html lang="zh">
<head>
<meta charset="UTF-8">
<title>减肥积分系统</title>
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

<style>
/* —— 样式未改动 —— */
:root{
  --bg-main:#f4f6fb;
  --bg-grad1:#eef2ff;
  --bg-grad2:#f7f4ff;
  --card-bg:rgba(255,255,255,.75);
  --border:rgba(30,30,60,.08);
  --text-main:#1c1f2a;
  --text-sub:#5a5f73;
  --accent:#6b7cff;
  --plus:#e6f6ee;
  --minus:#fde8ec;
  --weekend:#fff6dc;
}
*{box-sizing:border-box;font-family:-apple-system,BlinkMacSystemFont,"Segoe UI","PingFang SC","Microsoft YaHei",sans-serif;}
body{margin:0;padding:40px 24px 80px;background:linear-gradient(120deg,var(--bg-grad1),var(--bg-grad2),var(--bg-main));}
h1{font-size:40px;margin-bottom:32px;}
h2{font-size:20px;margin-bottom:16px;}
.section{background:var(--card-bg);border:1px solid var(--border);border-radius:18px;padding:24px;margin-bottom:28px;}
table{width:100%;border-collapse:collapse;font-size:14px;}
th,td{padding:8px 6px;text-align:center;}
th{border-bottom:1px solid var(--border);}
td{border-bottom:1px solid rgba(0,0,0,.04);}
.plus{background:var(--plus);}
.minus{background:var(--minus);}
.weekend{background:var(--weekend);}
input[type="number"]{width:64px;}
button{margin:24px 0;padding:10px 18px;border:none;border-radius:10px;background:var(--accent);color:#fff;}
canvas{max-height:220px;}
.table-wrap{background:var(--card-bg);border-radius:18px;padding:16px;}
</style>
</head>

<body>

<h1>减肥积分看板</h1>

<div class="section">
  <h2>积分排行榜</h2>
  <table>
    <thead><tr><th>姓名</th><th>本周</th><th>总计</th></tr></thead>
    <tbody id="rank"></tbody>
  </table>
</div>

<div class="section">
  <h2>体重趋势</h2>
  <canvas id="chart"></canvas>
</div>

<button onclick="addDay()">＋ 新增一天</button>

<div class="table-wrap">
<table>
<thead>
<tr>
<th>日期</th><th>姓名</th><th>签到</th><th>体重</th>
<th>变化</th><th>早睡</th><th>熬夜</th><th>运动</th>
<th>额外</th><th>得分</th>
</tr>
</thead>
<tbody id="records"></tbody>
</table>
</div>

<script>
const KEY="diet_records_v3";
const START_DATE="2025-11-14";
let data=JSON.parse(localStorage.getItem(KEY)||"[]");
let chart;

/* —— 原有逻辑完全不动 —— */
function isWeekend(d){d=new Date(d);return d.getDay()==0||d.getDay()==6;}
function weekStart(d){d=new Date(d);let day=d.getDay()||7;d.setDate(d.getDate()-day+1);return d.toISOString().slice(0,10);}
function lastWeight(name,idx){for(let i=idx-1;i>=0;i--){if(data[i].name===name&&data[i].weight!=="")return Number(data[i].weight);}return null;}
function score(r){
  let s=0;
  if(r.checkin)s+=1;
  if(r.weight!=="")s+=1;
  if(r.diff===1)s+=2;
  if(r.diff===-1)s-=2;
  if(r.sleepEarly)s+=2;
  if(r.sleepLate)s-=2;
  if(r.exercise)s+=2;
  if(isWeekend(r.date))s*=2;
  return s+Number(r.extra||0);
}

function addDay(){
  let next=data.length?new Date(data[data.length-1].date):new Date(START_DATE);
  if(data.length)next.setDate(next.getDate()+1);
  const d=next.toISOString().slice(0,10);
  ["千代","小德"].forEach(n=>{
    data.push({date:d,name:n,checkin:true,weight:"",diff:0,sleepEarly:false,sleepLate:false,exercise:false,extra:0});
  });
  save();
}

function update(i,k,v){
  data[i][k]=v;
  if(k==="weight"){
    let prev=lastWeight(data[i].name,i);
    if(prev!==null){
      if(Number(v)<prev)data[i].diff=1;
      else if(Number(v)>prev)data[i].diff=-1;
      else data[i].diff=0;
    }
  }
  save();
}

function save(){localStorage.setItem(KEY,JSON.stringify(data));render();}
function render(){renderTable();renderRank();renderChart();}

function renderTable(){
  const tb=document.getElementById("records");tb.innerHTML="";
  data.forEach((r,i)=>{
    const tr=document.createElement("tr");
    if(isWeekend(r.date))tr.classList.add("weekend");
    tr.innerHTML=`
<td>${r.date}</td><td>${r.name}</td>
<td class="${r.checkin?'plus':''}"><input type="checkbox" ${r.checkin?'checked':''} onchange="update(${i},'checkin',this.checked)"></td>
<td><input type="number" value="${r.weight}" onchange="update(${i},'weight',this.value)"></td>
<td class="${r.diff===1?'plus':r.diff===-1?'minus':''}">${r.diff===1?'↓':r.diff===-1?'↑':''}</td>
<td class="${r.sleepEarly?'plus':''}"><input type="checkbox" ${r.sleepEarly?'checked':''} onchange="update(${i},'sleepEarly',this.checked)"></td>
<td class="${r.sleepLate?'minus':''}"><input type="checkbox" ${r.sleepLate?'checked':''} onchange="update(${i},'sleepLate',this.checked)"></td>
<td class="${r.exercise?'plus':''}"><input type="checkbox" ${r.exercise?'checked':''} onchange="update(${i},'exercise',this.checked)"></td>
<td><input type="number" value="${r.extra}" onchange="update(${i},'extra',this.value)"></td>
<td>${score(r)}</td>`;
    tb.appendChild(tr);
  });
}

function renderRank(){
  const ws=weekStart(new Date()),sum={};
  data.forEach(r=>{
    if(!sum[r.name])sum[r.name]={w:0,t:0};
    const s=score(r);sum[r.name].t+=s;if(r.date>=ws)sum[r.name].w+=s;
  });
  document.getElementById("rank").innerHTML=Object.entries(sum).map(([n,v])=>`<tr><td>${n}</td><td>${v.w}</td><td>${v.t}</td></tr>`).join("");
}

function renderChart(){
  const labels=[...new Set(data.map(r=>r.date))];
  const ds={};
  data.forEach(r=>{if(r.weight==="")return;if(!ds[r.name])ds[r.name]={};ds[r.name][r.date]=Number(r.weight);});
  if(chart)chart.destroy();
  chart=new Chart(document.getElementById("chart"),{
    type:"line",
    data:{labels,datasets:Object.entries(ds).map(([n,m])=>({label:n,data:labels.map(d=>m[d]??null),spanGaps:true}))}
  });
}

render();
</script>

<!-- ===== Firebase 云端（仅修复数据层） ===== -->
<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
import { getFirestore, collection, doc, setDoc, getDocs } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

const app=initializeApp({
  apiKey:"AIzaSyAhZtgaE8mL3GkxsIj17g1ha-Y5HG02C_A",
  authDomain:"weight-zqy.firebaseapp.com",
  projectId:"weight-zqy"
});
const db=getFirestore(app);

window.saveToCloud=async()=>{
  const data=JSON.parse(localStorage.getItem(KEY)||"[]");
  for(const r of data){
    const id=`${r.date}_${r.name}`;
    await setDoc(doc(db,"records",id),{
      date:r.date,name:r.name,
      checkin:r.checkin,
      weight:r.weight===""?null:Number(r.weight),
      sleepEarly:r.sleepEarly,
      sleepLate:r.sleepLate,
      exercise:r.exercise,
      extra:Number(r.extra||0),
      updatedAt:Date.now()
    });
  }
  alert("云端保存完成");
};

window.loadFromCloud=async()=>{
  const snap=await getDocs(collection(db,"records"));
  const list=snap.docs.map(d=>{
    const r=d.data();
    return {...r,weight:r.weight??"",diff:0};
  }).sort((a,b)=>a.date.localeCompare(b.date)||a.name.localeCompare(b.name));
  localStorage.setItem(KEY,JSON.stringify(list));
  location.reload();
};
</script>

<button onclick="saveToCloud()">保存修改</button>
<button onclick="loadFromCloud()">读取</button>

</body>
</html>

