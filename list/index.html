<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>愿望清单</title>
    <!-- 法式衬线字体（兼容中文，打造优雅氛围） -->
    <link href="https://fonts.googleapis.com/css2?family=Noto+Serif+SC:wght@500;700&family=Garamond:wght@400;700&display=swap" rel="stylesheet">

    <style>
        :root {
            /* ===== 法式高级莫兰迪配色 ===== */
            --fg-main: #2C2825; /* 法式深棕文字（替代原浅灰，更有质感） */
            --fg-sub: #7A726B; /* 浅棕次级文字 */
            --fg-fade: #B0A8A0; /* 淡棕提示文字 */

            --bg-paper: #F9F7F5; /* 法式米白背景纸 */
            --bg-panel: #FFFFFF; /* 纯白面板 */
            --bg-soft: #F5F2EF; /* 法式浅灰柔色 */
            --bg-section: #FCFBF9; /* 区域浅背景 */

            --border-soft: #E8E5E1; /* 柔和边框色 */

            /* 愿望状态配色（法式莫兰迪柔和色调） */
            --accent-unfulfilled: #9AB3C9; /* 法式雾蓝（未实现） */
            --accent-unfulfilled-bg: #E6F0F8; /* 雾蓝背景 */
            --accent-unfulfilled-fade: rgba(154, 179, 201, 0.15); /* 雾蓝淡色 */

            --accent-fulfilled: #9FD3B6; /* 法式薄荷绿（已实现） */
            --accent-fulfilled-bg: #EEF7F1; /* 薄荷绿背景 */
            --accent-fulfilled-fade: rgba(159, 211, 182, 0.15); /* 薄荷绿淡色 */

            --accent-danger: #C98A8A; /* 法式柔粉（删除/垃圾桶） */
            --accent-danger-bg: #F9E6E8; /* 柔粉背景 */

            /* 法式精致圆角 */
            --radius-lg: 16px;
            --radius-md: 12px;
            --radius-sm: 8px;
            --radius-circle: 999px;

            /* 法式柔和阴影 */
            --shadow-soft: 0 4px 16px rgba(0, 0, 0, 0.06);
            --shadow-hover: 0 8px 24px rgba(0, 0, 0, 0.09);

            /* 顺滑过渡 */
            --transition: all .3s ease-in-out;
        }

        * {
            box-sizing: border-box;
        }

        body {
            margin: 0;
            padding: 48px 32px 120px;
            color: var(--fg-main);
            font-family: "Garamond", "Noto Serif SC", serif; /* 法式衬线字体 */
            background: 
                radial-gradient(1200px 800px at 20% 10%, #FFFFFF 0%, transparent 60%),
                radial-gradient(1000px 700px at 80% 20%, #Fcfaf7 0%, transparent 65%),
                var(--bg-paper); /* 替换原深色渐变，改为法式浅色调 */
        }

        h1 {
            text-align: center;
            font-family: "Noto Serif SC", serif;
            font-size: 3.2rem;
            letter-spacing: 4px;
            margin-bottom: 40px;
            color: #A67C52; /* 法式焦糖金棕强调色 */
            font-weight: 700;
        }

        .cloud-buttons {
            display: flex;
            justify-content: center;
            gap: 24px;
            margin-bottom: 48px;
            flex-wrap: wrap;
        }

        .cloud-buttons button {
            padding: 14px 32px;
            border-radius: var(--radius-sm);
            border: 1px solid var(--border-soft);
            background: var(--bg-panel);
            color: var(--fg-main);
            cursor: pointer;
            transition: var(--transition);
            box-shadow: var(--shadow-soft);
            font-size: 1.05rem;
            letter-spacing: 1px;
        }

        .cloud-buttons button:hover {
            border-color: var(--accent-unfulfilled);
            background: var(--bg-soft);
            transform: translateY(-3px);
            box-shadow: var(--shadow-hover);
        }

        /* ===== 主体布局 ===== */
        .wish-container {
            display: flex;
            gap: 32px;
            max-width: 1500px;
            margin: 0 auto;
        }

        .person-panel {
            flex: 1;
            padding: 32px 28px;
            background: var(--bg-panel);
            border-radius: var(--radius-lg);
            border: 1px solid var(--border-soft);
            box-shadow: var(--shadow-soft);
            transition: var(--transition);
        }

        .person-panel:hover {
            box-shadow: var(--shadow-hover);
            transform: translateY(-2px);
        }

        .person-title {
            font-family: "Noto Serif SC", serif;
            font-size: 1.8rem;
            letter-spacing: 2px;
            margin-bottom: 24px;
            text-align: center;
            color: var(--fg-main);
            padding-bottom: 16px;
            border-bottom: 1px solid var(--bg-soft);
        }

        .wish-sections {
            display: flex;
            gap: 20px;
            margin-bottom: 24px;
        }

        .wish-section {
            flex: 1;
            min-height: 280px;
            padding: 20px 18px;
            background: var(--bg-section);
            border-radius: var(--radius-md);
            border: 1px solid var(--border-soft);
            box-shadow: var(--shadow-soft);
            transition: var(--transition);
        }

        .wish-section:hover {
            background: var(--bg-soft);
            opacity: 0.95;
        }

        .section-title {
            text-align: center;
            font-size: 1.05rem;
            letter-spacing: 3px;
            color: var(--fg-sub);
            margin-bottom: 18px;
            text-transform: capitalize;
            font-weight: 500;
        }

        /* ===== 愿望条目 ===== */
        .wish-sticker {
            padding: 14px 18px;
            margin-bottom: 16px;
            border-radius: var(--radius-sm);
            background: var(--accent-unfulfilled-bg);
            border: 1px solid var(--accent-unfulfilled);
            cursor: grab;
            user-select: none;
            transition: var(--transition);
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.05);
            font-size: 1.05rem;
            letter-spacing: 0.5px;
        }

        .wish-sticker.fulfilled {
            background: var(--accent-fulfilled-bg);
            border-color: var(--accent-fulfilled);
        }

        .wish-sticker:active {
            cursor: grabbing;
            transform: scale(1.03) rotate(-1deg);
            box-shadow: var(--shadow-hover);
        }

        .wish-sticker:hover {
            transform: translateY(-1px);
            box-shadow: var(--shadow-soft);
        }

        /* ===== 输入区 ===== */
        .wish-input-container {
            display: flex;
            gap: 14px;
        }

        input[type="text"] {
            flex: 1;
            padding: 14px 20px;
            background: var(--bg-panel);
            border: 1px solid var(--border-soft);
            border-radius: var(--radius-sm);
            color: var(--fg-main);
            font-size: 1.05rem;
            transition: var(--transition);
            box-shadow: var(--shadow-soft);
            font-family: "Garamond", "Noto Serif SC", serif;
        }

        input::placeholder {
            color: var(--fg-fade);
            letter-spacing: 1px;
        }

        input:focus {
            outline: none;
            border-color: #A67C52;
            box-shadow: 0 0 0 3px rgba(166, 124, 82, 0.15);
            transform: translateY(-1px);
        }

        button {
            padding: 14px 26px;
            border-radius: var(--radius-sm);
            border: 1px solid var(--border-soft);
            background: var(--bg-panel);
            color: var(--fg-main);
            cursor: pointer;
            transition: var(--transition);
            box-shadow: var(--shadow-soft);
            font-size: 1.05rem;
            font-family: "Garamond", "Noto Serif SC", serif;
        }

        button:hover {
            border-color: #A67C52;
            background: var(--accent-light);
            transform: translateY(-2px);
            box-shadow: var(--shadow-hover);
        }

        /* ===== 垃圾桶 ===== */
        .trash-bin {
            position: fixed;
            left: 50%;
            bottom: 40px;
            transform: translateX(-50%);
            width: 88px;
            height: 88px;
            border-radius: 50%;
            background: var(--accent-danger);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 2.2rem;
            opacity: 0.85;
            transition: var(--transition);
            box-shadow: var(--shadow-soft);
            color: white;
        }

        .trash-bin.active {
            opacity: 1;
            transform: translateX(-50%) scale(1.08);
            background: #C96A6A;
            box-shadow: var(--shadow-hover);
        }

        /* ===== 拖拽占位 ===== */
        .placeholder {
            height: 52px;
            margin-bottom: 16px;
            border-radius: var(--radius-sm);
            border: 1px dashed var(--accent-unfulfilled);
            background: var(--accent-unfulfilled-fade);
        }

        .fulfilled-placeholder {
            border-color: var(--accent-fulfilled);
            background: var(--accent-fulfilled-fade);
        }

        /* ===== 响应式 ===== */
        @media (max-width: 900px) {
            .wish-container {
                flex-direction: column;
            }

            h1 {
                font-size: 2.4rem;
                margin-bottom: 32px;
            }

            .person-panel {
                padding: 24px 20px;
            }

            .trash-bin {
                width: 76px;
                height: 76px;
                font-size: 1.8rem;
            }
        }
    </style>
    <!-- 引入 Font Awesome 用于垃圾桶图标 -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
</head>
<body>
    <h1>愿望清单</h1>

    <!-- 云端保存/读取按钮（保留原有，无删除） -->
    <div class="cloud-buttons">
        <button onclick="saveToCloud()">保存愿望到云端</button>
        <button onclick="loadFromCloud()">从云端读取愿望</button>
    </div>

    <!-- 愿望清单主容器 -->
    <div class="wish-container">
        <!-- 千代的愿望面板 -->
        <div class="person-panel">
            <h2 class="person-title">千代的愿望</h2>
            <div class="wish-sections">
                <div class="wish-section" id="chiyo-wish-list" data-section="unfulfilled" data-person="chiyo">
                    <h3 class="section-title">愿望清单</h3>
                </div>
                <div class="wish-section" id="chiyo-fulfilled" data-section="fulfilled" data-person="chiyo">
                    <h3 class="section-title">已实现</h3>
                </div>
            </div>
            <div class="wish-input-container">
                <input type="text" id="chiyo-input" placeholder="输入新愿望...">
                <button onclick="addWish('chiyo')">添加</button>
            </div>
        </div>

        <!-- 小德的愿望面板 -->
        <div class="person-panel">
            <h2 class="person-title">小德的愿望</h2>
            <div class="wish-sections">
                <div class="wish-section" id="xiaode-wish-list" data-section="unfulfilled" data-person="xiaode">
                    <h3 class="section-title">愿望清单</h3>
                </div>
                <div class="wish-section" id="xiaode-fulfilled" data-section="fulfilled" data-person="xiaode">
                    <h3 class="section-title">已实现</h3>
                </div>
            </div>
            <div class="wish-input-container">
                <input type="text" id="xiaode-input" placeholder="输入新愿望...">
                <button onclick="addWish('xiaode')">添加</button>
            </div>
        </div>
    </div>

    <!-- 垃圾桶 -->
    <div class="trash-bin" id="trash-bin">
        <i class="fas fa-trash"></i>
    </div>

    <!-- Firebase 配置与核心逻辑 -->
    <script type="module">
        // 导入 Firebase
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import {
            getFirestore,
            collection,
            writeBatch,
            getDocs,
            doc
        } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

        // Firebase 配置（沿用原有项目配置）
        const firebaseConfig = {
            apiKey: "AIzaSyAhZtgaE8mL3GkxsIj17g1ha-Y5HG02C_A",
            authDomain: "weight-zqy.firebaseapp.com",
            projectId: "weight-zqy",
            storageBucket: "weight-zqy.firebasestorage.app",
            messagingSenderId: "710580530798",
            appId: "1:710580530798:web:30e48f089452364c02c07f"
        };

        // 初始化 Firebase
        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);
        const WISH_KEY = "wish_list_v1"; // 本地存储键
        let wishData = JSON.parse(localStorage.getItem(WISH_KEY) || '{"chiyo":[],"xiaode":[]}');

        // 全局拖拽相关变量
        let draggingSticker = null;
        let placeholder = null;
        let currentSection = null;

        // ========== 本地数据操作 ==========
        // 保存到本地 localStorage
        function saveToLocal() {
            localStorage.setItem(WISH_KEY, JSON.stringify(wishData));
        }

        // 渲染所有愿望
        function renderWishes() {
            // 清空两个面板的所有内容
            document.getElementById("chiyo-wish-list").innerHTML = '<h3 class="section-title">愿望清单</h3>';
            document.getElementById("chiyo-fulfilled").innerHTML = '<h3 class="section-title">已实现</h3>';
            document.getElementById("xiaode-wish-list").innerHTML = '<h3 class="section-title">愿望清单</h3>';
            document.getElementById("xiaode-fulfilled").innerHTML = '<h3 class="section-title">已实现</h3>';

            // 渲染千代的愿望
            wishData.chiyo.forEach((wish, index) => {
                const sticker = createWishSticker("chiyo", index, wish);
                const targetSection = wish.fulfilled 
                    ? document.getElementById("chiyo-fulfilled")
                    : document.getElementById("chiyo-wish-list");
                targetSection.appendChild(sticker);
            });

            // 渲染小德的愿望
            wishData.xiaode.forEach((wish, index) => {
                const sticker = createWishSticker("xiaode", index, wish);
                const targetSection = wish.fulfilled 
                    ? document.getElementById("xiaode-fulfilled")
                    : document.getElementById("xiaode-wish-list");
                targetSection.appendChild(sticker);
            });
        }

        // 创建愿望贴纸元素
        function createWishSticker(person, index, wish) {
            const sticker = document.createElement("div");
            sticker.className = `wish-sticker ${wish.fulfilled ? 'fulfilled' : ''}`;
            sticker.dataset.person = person;
            sticker.dataset.index = index;
            sticker.innerText = wish.content;

            // 绑定拖拽事件
            sticker.addEventListener("mousedown", startDrag);
            sticker.addEventListener("touchstart", startDrag, { passive: true });

            return sticker;
        }

        // 添加新愿望
        function addWish(person) {
            const input = document.getElementById(`${person}-input`);
            const content = input.value.trim();
            if (!content) return;

            // 添加到本地数据
            wishData[person].push({
                content: content,
                fulfilled: false,
                createTime: Date.now()
            });

            // 保存并重新渲染
            saveToLocal();
            renderWishes();

            // 清空输入框
            input.value = "";
        }

        // 删除愿望
        function deleteWish(person, index) {
            wishData[person].splice(index, 1);
            saveToLocal();
            renderWishes();
        }

        // 更新愿望状态（已实现/未实现）
        function updateWishStatus(person, index, fulfilled) {
            wishData[person][index].fulfilled = fulfilled;
            saveToLocal();
            renderWishes();
        }

        // ========== 拖拽功能实现 ==========
        // 开始拖拽
        function startDrag(e) {
            draggingSticker = this;
            currentSection = draggingSticker.parentElement;

            // 创建占位符
            placeholder = document.createElement("div");
            placeholder.className = `placeholder ${currentSection.dataset.section === 'fulfilled' ? 'fulfilled-placeholder' : ''}`;
            draggingSticker.parentNode.insertBefore(placeholder, draggingSticker);

            // 隐藏原贴纸（通过透明度，保持布局）
            draggingSticker.style.opacity = "0.5";

            // 绑定移动和结束事件
            document.addEventListener("mousemove", dragMove);
            document.addEventListener("mouseup", endDrag);
            document.addEventListener("touchmove", dragMove, { passive: true });
            document.addEventListener("touchend", endDrag);
        }

        // 拖拽移动
        function dragMove(e) {
            if (!draggingSticker) return;

            // 兼容鼠标和触摸事件
            let clientX = e.clientX || (e.touches && e.touches[0].clientX);
            let clientY = e.clientY || (e.touches && e.touches[0].clientY);

            // 设置贴纸跟随鼠标/触摸点
            draggingSticker.style.position = "absolute";
            draggingSticker.style.left = `${clientX - draggingSticker.offsetWidth / 2}px`;
            draggingSticker.style.top = `${clientY - draggingSticker.offsetHeight / 2}px`;

            // 检测是否进入垃圾桶
            const trashBin = document.getElementById("trash-bin");
            const trashRect = trashBin.getBoundingClientRect();
            const isOverTrash = clientX >= trashRect.left && clientX <= trashRect.right &&
                                clientY >= trashRect.top && clientY <= trashRect.bottom;

            // 切换垃圾桶激活状态
            if (isOverTrash) {
                trashBin.classList.add("active");
            } else {
                trashBin.classList.remove("active");
            }

            // 检测是否进入其他愿望区域（实现排序/状态切换）
            const wishSections = document.querySelectorAll(".wish-section");
            wishSections.forEach(section => {
                const rect = section.getBoundingClientRect();
                if (clientX >= rect.left && clientX <= rect.right && clientY >= rect.top && clientY <= rect.bottom) {
                    // 找到插入位置（简化版：直接替换占位符到当前区域）
                    if (section !== currentSection) {
                        currentSection = section;
                        // 更新占位符样式为目标区域类型
                        placeholder.className = `placeholder ${currentSection.dataset.section === 'fulfilled' ? 'fulfilled-placeholder' : ''}`;
                        section.appendChild(placeholder);
                    }
                }
            });
        }

        // 结束拖拽
        function endDrag(e) {
            if (!draggingSticker) return;

            // 恢复贴纸样式
            draggingSticker.style.opacity = "1";
            draggingSticker.style.position = "";
            draggingSticker.style.left = "";
            draggingSticker.style.top = "";

            // 检测是否删除（放入垃圾桶）
            const trashBin = document.getElementById("trash-bin");
            const trashRect = trashBin.getBoundingClientRect();
            let clientX = e.clientX || (e.changedTouches && e.changedTouches[0].clientX);
            let clientY = e.clientY || (e.changedTouches && e.changedTouches[0].clientY);
            const isOverTrash = clientX >= trashRect.left && clientX <= trashRect.right &&
                                clientY >= trashRect.top && clientY <= trashRect.bottom;

            if (isOverTrash) {
                // 删除愿望
                const person = draggingSticker.dataset.person;
                const index = parseInt(draggingSticker.dataset.index);
                deleteWish(person, index);
            } else {
                // 切换愿望状态（根据目标区域）
                const person = draggingSticker.dataset.person;
                const index = parseInt(draggingSticker.dataset.index);
                const isFulfilledSection = currentSection.dataset.section === "fulfilled";
                
                // 更新状态并插入到目标区域
                updateWishStatus(person, index, isFulfilledSection);
                currentSection.replaceChild(draggingSticker, placeholder);
            }

            // 清空拖拽变量
            draggingSticker = null;
            placeholder = null;
            currentSection = null;
            trashBin.classList.remove("active");

            // 解绑事件
            document.removeEventListener("mousemove", dragMove);
            document.removeEventListener("mouseup", endDrag);
            document.removeEventListener("touchmove", dragMove);
            document.removeEventListener("touchend", endDrag);
        }

        // ========== 云端数据同步（含自动读取优化） ==========
        // 保存到 Firebase 云端
        async function saveToCloudImpl() {
            try {
                const wishesRef = collection(db, "wishes");

                // 步骤1：删除云端旧数据
                const oldSnap = await getDocs(wishesRef);
                const batch = writeBatch(db);
                oldSnap.docs.forEach(docItem => {
                    batch.delete(docItem.ref);
                });
                await batch.commit();

                // 步骤2：批量上传最新愿望数据
                const newBatch = writeBatch(db);
                const docRef = doc(wishesRef); // 生成唯一文档
                newBatch.set(docRef, {
                    chiyo: wishData.chiyo,
                    xiaode: wishData.xiaode,
                    updateTime: Date.now()
                });
                await newBatch.commit();

                alert("愿望数据已成功保存到云端！");
            } catch (e) {
                alert(`保存失败：${e.message || JSON.stringify(e)}`);
                console.error("云端保存错误：", e);
            }
        }

        // 从 Firebase 云端读取（优化：自动读取时静默无弹窗）
        async function loadFromCloudImpl() {
            try {
                const wishesRef = collection(db, "wishes");
                const snap = await getDocs(wishesRef);

                if (snap.empty) {
                    // 自动读取时仅打印日志，不弹窗干扰
                    console.log("云端暂无愿望数据，使用本地存储数据");
                    // 手动点击时才弹窗提示
                    if (document.activeElement?.innerText === "从云端读取愿望") {
                        alert("云端暂无愿望数据！");
                    }
                    return;
                }

                // 提取最新数据
                const cloudData = snap.docs[0].data();
                wishData.chiyo = cloudData.chiyo || [];
                wishData.xiaode = cloudData.xiaode || [];

                // 保存到本地并渲染
                saveToLocal();
                renderWishes();

                // 仅手动点击时弹窗提示，自动读取时静默
                if (document.activeElement?.innerText === "从云端读取愿望") {
                    alert("愿望数据已从云端成功读取！");
                } else {
                    console.log("愿望数据已从云端自动读取并渲染");
                }
            } catch (e) {
                console.error("云端读取错误：", e);
                // 仅手动点击时弹窗提示错误
                if (document.activeElement?.innerText === "从云端读取愿望") {
                    alert(`读取失败：${e.message || JSON.stringify(e)}`);
                }
            }
        }

        // ========== 全局函数挂载（解决模块作用域问题） ==========
        window.addWish = addWish;
        window.saveToCloud = saveToCloudImpl;
        window.loadFromCloud = loadFromCloudImpl;

        // ========== 页面初始化（核心：自动调用云端读取函数） ==========
        // 1. 先自动静默读取云端数据（await确保异步操作完成）
        await loadFromCloudImpl();
        // 2. 再渲染页面内容（确保云端数据优先加载）
        renderWishes();
    </script>
</body>
</html>
