<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>愿望清单</title>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Serif+SC:wght@500;700&family=Inter:wght@300;400&display=swap" rel="stylesheet">

    <style>
        :root {
  --fg-main: #E8E8F0;
  --fg-sub: #A0A0B8;

  --bg-panel: rgba(255,255,255,0.06);
  --bg-soft: rgba(255,255,255,0.04);
  --border-soft: rgba(255,255,255,0.18);

  --accent-unfulfilled: rgba(183,168,255,0.35);
  --accent-fulfilled: rgba(140,200,170,0.35);
  --accent-danger: #EF5350;

  --radius-lg: 18px;
  --radius-md: 14px;
  --radius-sm: 10px;
}

* {
  box-sizing: border-box;
}

body {
  margin: 0;
  padding: 48px 32px 120px;
  color: var(--fg-main);
  font-family: Inter, sans-serif;
  background:
    radial-gradient(1200px 800px at 20% 10%, #1b1f3b 0%, transparent 60%),
    radial-gradient(1000px 700px at 80% 20%, #2a174a 0%, transparent 65%),
    linear-gradient(180deg, #090b16, #05060c);
}

h1 {
  text-align: center;
  font-family: "Noto Serif SC", serif;
  font-size: 42px;
  letter-spacing: 4px;
  margin-bottom: 36px;
}

.cloud-buttons {
  display: flex;
  justify-content: center;
  gap: 18px;
  margin-bottom: 36px;
}

.cloud-buttons button {
  padding: 10px 26px;
  border-radius: 999px;
  border: 1px solid var(--border-soft);
  background: var(--bg-soft);
  color: var(--fg-main);
  cursor: pointer;
  backdrop-filter: blur(6px);
}

.cloud-buttons button:hover {
  border-color: #B7A8FF;
}

/* ===== 主体布局 ===== */
.wish-container {
  display: flex;
  gap: 28px;
}

.person-panel {
  flex: 1;
  padding: 24px;
  background: var(--bg-panel);
  border-radius: var(--radius-lg);
  border: 1px solid var(--border-soft);
  backdrop-filter: blur(10px);
}

.person-title {
  font-family: "Noto Serif SC", serif;
  font-size: 22px;
  letter-spacing: 2px;
  margin-bottom: 20px;
  text-align: center;
}

.wish-sections {
  display: flex;
  gap: 16px;
  margin-bottom: 20px;
}

.wish-section {
  flex: 1;
  min-height: 280px;
  padding: 16px;
  background: rgba(0,0,0,0.25);
  border-radius: var(--radius-md);
  border: 1px dashed rgba(255,255,255,0.15);
}

.section-title {
  text-align: center;
  font-size: 13px;
  letter-spacing: 3px;
  color: var(--fg-sub);
  margin-bottom: 14px;
}

/* ===== 愿望条目 ===== */
.wish-sticker {
  padding: 12px 16px;
  margin-bottom: 12px;
  border-radius: var(--radius-sm);
  background: rgba(183,168,255,0.15);
  border: 1px solid var(--accent-unfulfilled);
  cursor: grab;
  user-select: none;
}

.wish-sticker.fulfilled {
  background: rgba(140,200,170,0.18);
  border-color: var(--accent-fulfilled);
}

.wish-sticker:active {
  cursor: grabbing;
  transform: scale(1.03);
}

/* ===== 输入区 ===== */
.wish-input-container {
  display: flex;
  gap: 10px;
}

input[type="text"] {
  flex: 1;
  padding: 10px 14px;
  background: rgba(0,0,0,0.35);
  border: 1px solid var(--border-soft);
  border-radius: 999px;
  color: var(--fg-main);
}

input::placeholder {
  color: var(--fg-sub);
}

button {
  padding: 10px 22px;
  border-radius: 999px;
  border: 1px solid var(--border-soft);
  background: var(--bg-soft);
  color: var(--fg-main);
  cursor: pointer;
}

button:hover {
  border-color: #B7A8FF;
}

/* ===== 垃圾桶 ===== */
.trash-bin {
  position: fixed;
  left: 50%;
  bottom: 36px;
  transform: translateX(-50%);
  width: 72px;
  height: 72px;
  border-radius: 50%;
  background: rgba(239,83,80,0.75);
  display: flex;
  align-items: center;
  justify-content: center;
  font-size: 26px;
  opacity: 0.6;
  backdrop-filter: blur(6px);
}

.trash-bin.active {
  opacity: 1;
  transform: translateX(-50%) scale(1.15);
}

/* ===== 拖拽占位 ===== */
.placeholder {
  height: 44px;
  margin-bottom: 12px;
  border-radius: var(--radius-sm);
  border: 1px dashed var(--accent-unfulfilled);
  background: rgba(183,168,255,0.12);
}

.fulfilled-placeholder {
  border-color: var(--accent-fulfilled);
  background: rgba(140,200,170,0.12);
}

/* ===== 响应式 ===== */
@media (max-width: 900px) {
  .wish-container {
    flex-direction: column;
  }
}

    </style>
    <!-- 引入 Font Awesome 用于垃圾桶图标 -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
</head>
<body>
    <h1>愿望清单</h1>

    <!-- 云端保存/读取按钮 -->
    <div class="cloud-buttons">
        <button onclick="saveToCloud()">保存愿望到云端</button>
        <button onclick="loadFromCloud()">从云端读取愿望</button>
    </div>

    <!-- 愿望清单主容器 -->
    <div class="wish-container">
        <!-- 千代的愿望面板 -->
        <div class="person-panel">
            <h2 class="person-title">千代的愿望</h2>
            <div class="wish-sections">
                <div class="wish-section" id="chiyo-wish-list" data-section="unfulfilled" data-person="chiyo">
                    <h3 class="section-title">愿望清单</h3>
                </div>
                <div class="wish-section" id="chiyo-fulfilled" data-section="fulfilled" data-person="chiyo">
                    <h3 class="section-title">已实现</h3>
                </div>
            </div>
            <div class="wish-input-container">
                <input type="text" id="chiyo-input" placeholder="输入新愿望...">
                <button onclick="addWish('chiyo')">添加</button>
            </div>
        </div>

        <!-- 小德的愿望面板 -->
        <div class="person-panel">
            <h2 class="person-title">小德的愿望</h2>
            <div class="wish-sections">
                <div class="wish-section" id="xiaode-wish-list" data-section="unfulfilled" data-person="xiaode">
                    <h3 class="section-title">愿望清单</h3>
                </div>
                <div class="wish-section" id="xiaode-fulfilled" data-section="fulfilled" data-person="xiaode">
                    <h3 class="section-title">已实现</h3>
                </div>
            </div>
            <div class="wish-input-container">
                <input type="text" id="xiaode-input" placeholder="输入新愿望...">
                <button onclick="addWish('xiaode')">添加</button>
            </div>
        </div>
    </div>

    <!-- 垃圾桶 -->
    <div class="trash-bin" id="trash-bin">
        <i class="fas fa-trash"></i>
    </div>

    <!-- Firebase 配置与核心逻辑 -->
    <script type="module">
        // 导入 Firebase
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import {
            getFirestore,
            collection,
            writeBatch,
            getDocs,
            doc
        } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

        // Firebase 配置（沿用你的原有项目配置）
        const firebaseConfig = {
            apiKey: "AIzaSyAhZtgaE8mL3GkxsIj17g1ha-Y5HG02C_A",
            authDomain: "weight-zqy.firebaseapp.com",
            projectId: "weight-zqy",
            storageBucket: "weight-zqy.firebasestorage.app",
            messagingSenderId: "710580530798",
            appId: "1:710580530798:web:30e48f089452364c02c07f"
        };

        // 初始化 Firebase
        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);
        const WISH_KEY = "wish_list_v1"; // 本地存储键
        let wishData = JSON.parse(localStorage.getItem(WISH_KEY) || '{"chiyo":[],"xiaode":[]}');

        // 全局拖拽相关变量
        let draggingSticker = null;
        let placeholder = null;
        let currentSection = null;

        // ========== 本地数据操作 ==========
        // 保存到本地 localStorage
        function saveToLocal() {
            localStorage.setItem(WISH_KEY, JSON.stringify(wishData));
        }

        // 渲染所有愿望
        function renderWishes() {
            // 清空两个面板的所有内容
            document.getElementById("chiyo-wish-list").innerHTML = '<h3 class="section-title">愿望清单</h3>';
            document.getElementById("chiyo-fulfilled").innerHTML = '<h3 class="section-title">已实现</h3>';
            document.getElementById("xiaode-wish-list").innerHTML = '<h3 class="section-title">愿望清单</h3>';
            document.getElementById("xiaode-fulfilled").innerHTML = '<h3 class="section-title">已实现</h3>';

            // 渲染千代的愿望
            wishData.chiyo.forEach((wish, index) => {
                const sticker = createWishSticker("chiyo", index, wish);
                const targetSection = wish.fulfilled 
                    ? document.getElementById("chiyo-fulfilled")
                    : document.getElementById("chiyo-wish-list");
                targetSection.appendChild(sticker);
            });

            // 渲染小德的愿望
            wishData.xiaode.forEach((wish, index) => {
                const sticker = createWishSticker("xiaode", index, wish);
                const targetSection = wish.fulfilled 
                    ? document.getElementById("xiaode-fulfilled")
                    : document.getElementById("xiaode-wish-list");
                targetSection.appendChild(sticker);
            });
        }

        // 创建愿望贴纸元素
        function createWishSticker(person, index, wish) {
            const sticker = document.createElement("div");
            sticker.className = `wish-sticker ${wish.fulfilled ? 'fulfilled' : ''}`;
            sticker.dataset.person = person;
            sticker.dataset.index = index;
            sticker.innerText = wish.content;

            // 绑定拖拽事件
            sticker.addEventListener("mousedown", startDrag);
            sticker.addEventListener("touchstart", startDrag, { passive: true });

            return sticker;
        }

        // 添加新愿望
        function addWish(person) {
            const input = document.getElementById(`${person}-input`);
            const content = input.value.trim();
            if (!content) return;

            // 添加到本地数据
            wishData[person].push({
                content: content,
                fulfilled: false,
                createTime: Date.now()
            });

            // 保存并重新渲染
            saveToLocal();
            renderWishes();

            // 清空输入框
            input.value = "";
        }

        // 删除愿望
        function deleteWish(person, index) {
            wishData[person].splice(index, 1);
            saveToLocal();
            renderWishes();
        }

        // 更新愿望状态（已实现/未实现）
        function updateWishStatus(person, index, fulfilled) {
            wishData[person][index].fulfilled = fulfilled;
            saveToLocal();
            renderWishes();
        }

        // ========== 拖拽功能实现 ==========
        // 开始拖拽
        function startDrag(e) {
            draggingSticker = this;
            currentSection = draggingSticker.parentElement;

            // 创建占位符
            placeholder = document.createElement("div");
            placeholder.className = `placeholder ${currentSection.dataset.section === 'fulfilled' ? 'fulfilled-placeholder' : ''}`;
            draggingSticker.parentNode.insertBefore(placeholder, draggingSticker);

            // 隐藏原贴纸（通过透明度，保持布局）
            draggingSticker.style.opacity = "0.5";

            // 绑定移动和结束事件
            document.addEventListener("mousemove", dragMove);
            document.addEventListener("mouseup", endDrag);
            document.addEventListener("touchmove", dragMove, { passive: true });
            document.addEventListener("touchend", endDrag);
        }

        // 拖拽移动
        function dragMove(e) {
            if (!draggingSticker) return;

            // 兼容鼠标和触摸事件
            let clientX = e.clientX || (e.touches && e.touches[0].clientX);
            let clientY = e.clientY || (e.touches && e.touches[0].clientY);

            // 设置贴纸跟随鼠标/触摸点
            draggingSticker.style.position = "absolute";
            draggingSticker.style.left = `${clientX - draggingSticker.offsetWidth / 2}px`;
            draggingSticker.style.top = `${clientY - draggingSticker.offsetHeight / 2}px`;

            // 检测是否进入垃圾桶
            const trashBin = document.getElementById("trash-bin");
            const trashRect = trashBin.getBoundingClientRect();
            const isOverTrash = clientX >= trashRect.left && clientX <= trashRect.right &&
                                clientY >= trashRect.top && clientY <= trashRect.bottom;

            // 切换垃圾桶激活状态
            if (isOverTrash) {
                trashBin.classList.add("active");
            } else {
                trashBin.classList.remove("active");
            }

            // 检测是否进入其他愿望区域（实现排序/状态切换）
            const wishSections = document.querySelectorAll(".wish-section");
            wishSections.forEach(section => {
                const rect = section.getBoundingClientRect();
                if (clientX >= rect.left && clientX <= rect.right && clientY >= rect.top && clientY <= rect.bottom) {
                    // 找到插入位置（简化版：直接替换占位符到当前区域）
                    if (section !== currentSection) {
                        currentSection = section;
                        section.appendChild(placeholder);
                    }
                }
            });
        }

        // 结束拖拽
        function endDrag(e) {
            if (!draggingSticker) return;

            // 恢复贴纸样式
            draggingSticker.style.opacity = "1";
            draggingSticker.style.position = "";
            draggingSticker.style.left = "";
            draggingSticker.style.top = "";

            // 检测是否删除（放入垃圾桶）
            const trashBin = document.getElementById("trash-bin");
            const trashRect = trashBin.getBoundingClientRect();
            let clientX = e.clientX || (e.changedTouches && e.changedTouches[0].clientX);
            let clientY = e.clientY || (e.changedTouches && e.changedTouches[0].clientY);
            const isOverTrash = clientX >= trashRect.left && clientX <= trashRect.right &&
                                clientY >= trashRect.top && clientY <= trashRect.bottom;

            if (isOverTrash) {
                // 删除愿望
                const person = draggingSticker.dataset.person;
                const index = parseInt(draggingSticker.dataset.index);
                deleteWish(person, index);
            } else {
                // 切换愿望状态（根据目标区域）
                const person = draggingSticker.dataset.person;
                const index = parseInt(draggingSticker.dataset.index);
                const isFulfilledSection = currentSection.dataset.section === "fulfilled";
                
                // 更新状态并插入到目标区域
                updateWishStatus(person, index, isFulfilledSection);
                currentSection.replaceChild(draggingSticker, placeholder);
            }

            // 清空拖拽变量
            draggingSticker = null;
            placeholder = null;
            currentSection = null;
            trashBin.classList.remove("active");

            // 解绑事件
            document.removeEventListener("mousemove", dragMove);
            document.removeEventListener("mouseup", endDrag);
            document.removeEventListener("touchmove", dragMove);
            document.removeEventListener("touchend", endDrag);
        }

        // ========== 云端数据同步 ==========
        // 保存到 Firebase 云端
        async function saveToCloudImpl() {
            try {
                const wishesRef = collection(db, "wishes");

                // 步骤1：删除云端旧数据
                const oldSnap = await getDocs(wishesRef);
                const batch = writeBatch(db);
                oldSnap.docs.forEach(docItem => {
                    batch.delete(docItem.ref);
                });
                await batch.commit();

                // 步骤2：批量上传最新愿望数据
                const newBatch = writeBatch(db);
                const docRef = doc(wishesRef); // 生成唯一文档
                newBatch.set(docRef, {
                    chiyo: wishData.chiyo,
                    xiaode: wishData.xiaode,
                    updateTime: Date.now()
                });
                await newBatch.commit();

                alert("愿望数据已成功保存到云端！");
            } catch (e) {
                alert(`保存失败：${e.message || JSON.stringify(e)}`);
                console.error("云端保存错误：", e);
            }
        }

        // 从 Firebase 云端读取
        async function loadFromCloudImpl() {
            try {
                const wishesRef = collection(db, "wishes");
                const snap = await getDocs(wishesRef);

                if (snap.empty) {
                    alert("云端暂无愿望数据！");
                    return;
                }

                // 提取最新数据
                const cloudData = snap.docs[0].data();
                wishData.chiyo = cloudData.chiyo || [];
                wishData.xiaode = cloudData.xiaode || [];

                // 保存到本地并渲染
                saveToLocal();
                renderWishes();
                alert("愿望数据已从云端成功读取！");
            } catch (e) {
                alert(`读取失败：${e.message || JSON.stringify(e)}`);
                console.error("云端读取错误：", e);
            }
        }

        // ========== 全局函数挂载（解决模块作用域问题） ==========
        window.addWish = addWish;
        window.saveToCloud = saveToCloudImpl;
        window.loadFromCloud = loadFromCloudImpl;

        // ========== 页面初始化 ==========
        renderWishes();
    </script>
</body>
</html>
